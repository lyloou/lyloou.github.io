<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lyloou.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="&#x2F;* Better than last best *&#x2F;">
<meta property="og:type" content="website">
<meta property="og:title" content="lyloou">
<meta property="og:url" content="https://lyloou.com/page/3/index.html">
<meta property="og:site_name" content="lyloou">
<meta property="og:description" content="&#x2F;* Better than last best *&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lyloou">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://lyloou.com/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>lyloou</title>
  
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-80542932-1","only_pageview":true}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">lyloou</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lyloou"
      src="/assets/images/avatar.png">
  <p class="site-author-name" itemprop="name">lyloou</p>
  <div class="site-description" itemprop="description">/* Better than last best */</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">312</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/lyloou" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lyloou" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:lyloou6@gmail.com" title="E-Mail → mailto:lyloou6@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/lyloou" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;lyloou" rel="noopener me" target="_blank"><i class="weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/ly1414725328" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;ly1414725328" rel="noopener me" target="_blank"><i class="csdn fa-fw"></i>CSDN</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/ssm/Spring%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/ssm/Spring%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="post-title-link" itemprop="url">Spring 的生命周期</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-16 11:41:27" itemprop="dateCreated datePublished" datetime="2021-12-16T11:41:27+08:00">2021-12-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="Spring-的生命周期"><a href="#Spring-的生命周期" class="headerlink" title="Spring 的生命周期"></a>Spring 的生命周期</h4><ol>
<li>实例化（Instanctiation）</li>
<li>属性填充（Populate）</li>
<li>初始化（Initialization）</li>
<li>销毁（Destruction）</li>
</ol>
<blockquote>
<p>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean<br><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/1b022eef-895d-4f8e-bd1b-a67bd8740a74_20211217114231733_9c8c98.png" alt="img"><br><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/d0cd34bf-96d8-4a56-ae66-e41c3bac6c5d_20211216114015327_6687b3.jpg" alt="img"></p>
</blockquote>
<h6 id="1-实例化"><a href="#1-实例化" class="headerlink" title="1. 实例化"></a>1. 实例化</h6><p>判断是否存在方法覆盖，如果有，使用 JDK 的反射机制来实例化。<br>如果没有，使用 CGLib 技术实例化。<br><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/d4ee5cad-5b5e-440a-8a3f-865cf5f10ab3_20211217114246020_9bdc78.png" alt="img"></p>
<h6 id="2-属性填充"><a href="#2-属性填充" class="headerlink" title="2.属性填充"></a>2.属性填充</h6><p>分为：按名称填充、和按类型填充<br><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/37667b6c-c43d-48ad-b7ce-e7d3123ed12c_20211216114015366_6bdf8b.png" alt="img"></p>
<h6 id="3-初始化"><a href="#3-初始化" class="headerlink" title="3.初始化"></a>3.初始化</h6><ol>
<li>Aware 相关回调</li>
<li>初始化前置处理</li>
<li>初始化</li>
<li>初始化后置处理</li>
</ol>
<blockquote>
<p>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean<br><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/ca4cb8e0-2c87-4d94-9db6-eaa6f38d4665_20211216114015353_f375f6.png" alt="img"></p>
</blockquote>
<h6 id="销毁"><a href="#销毁" class="headerlink" title="销毁"></a>销毁</h6><p>从容器中，移除 beanName<br>调用 DesposableBean.distroy 接口<br><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/faefd2dc-114c-4dbb-9850-99598310a635_20211217114256213_243b26.png" alt="img"></p>
<h6 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h6><ul>
<li><p>附件 1：Spring 生命周期-创建和初始化.pdf</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://0f9de7f3.wiz06.com/wapp/pages/view/share/s/0fDuvP3SO4QS2Hb3sP2Di0ai1Gi4xr0PNQk-2VJor-2R5iil">Spring 源码解析</a></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91/" class="post-title-link" itemprop="url">数据结构-树</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-15 17:11:52" itemprop="dateCreated datePublished" datetime="2021-12-15T17:11:52+08:00">2021-12-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="二叉查找树"><a href="#二叉查找树" class="headerlink" title="二叉查找树"></a>二叉查找树</h2><p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91-1-BST_20211215185025493_b2fc35.png" alt="数据结构-树-1-BST"></p>
<h2 id="平衡树"><a href="#平衡树" class="headerlink" title="平衡树"></a>平衡树</h2><p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91_%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91-2-AVL_2021-12-16-09-23-23.png" alt="数据结构-树_数据结构-树-2-AVL_2021-12-16-09-23-23"></p>
<h2 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h2><p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91_%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91-3-RBTree_2021-12-16-09-23-46.png" alt="数据结构-树_数据结构-树-3-RBTree_2021-12-16-09-23-46"></p>
<h2 id="平衡多路查找树"><a href="#平衡多路查找树" class="headerlink" title="平衡多路查找树"></a>平衡多路查找树</h2><p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91-4-B-Tree_20211215185054559_400b95.png" alt="数据结构-树-4-B-Tree"></p>
<h2 id="B-树"><a href="#B-树" class="headerlink" title="B+树"></a>B+树</h2><p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91-5-B%2BTree_20211215185101793_088b18.png" alt="数据结构-树-5-B+Tree"></p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p>导图地址：【金山文档】 数据结构-树 <a target="_blank" rel="noopener" href="https://kdocs.cn/l/se9RNa0rOTyq">https://kdocs.cn/l/se9RNa0rOTyq</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/business/%E5%8F%96%E5%9B%9B%E4%B8%AA%E5%9C%BA%E6%AC%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/business/%E5%8F%96%E5%9B%9B%E4%B8%AA%E5%9C%BA%E6%AC%A1/" class="post-title-link" itemprop="url">取四个场次</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-10 17:21:37" itemprop="dateCreated datePublished" datetime="2021-12-10T17:21:37+08:00">2021-12-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>假设一个活动中，有 n 个<code>（n的范围是 1&lt;n&lt;10）</code>场次，场次按时间顺序依次进行。<br>其中每个场次有三种状态：「未开始」、「进行中」、「已结束」<br>要求：以当前时间点为参考点，从场次列表中获取最多 4 个场次。<br>场次具体要求如下：</p>
<ol>
<li>不满足 4 场次或正好 4 场次的全部返回。</li>
<li>大于 4 场次时，获取的四个场次有下面这些情况（场次充足的情况下，只有一个【已结束】的场次）：<br>【未开始、未开始、未开始、未开始】<br>【已结束、未开始、未开始、未开始】<br>【已结束、进行中、未开始、未开始】<br>…</li>
</ol>
<h2 id="解决文案："><a href="#解决文案：" class="headerlink" title="解决文案："></a>解决文案：</h2><p><strong>突破点</strong></p>
<p>找到【已结束】的下标，并以此下标为中心来推断其它几个场次。</p>
<p><strong>具体解决步骤</strong></p>
<ol>
<li>少于 4 场次，全部返回；</li>
<li>多余 4 场次，按以下规则取<br>设：index 为最后一个已结束的场次下标，size 为场次列表数量，hasNext 为是否有下一个场次<br>&lt;1. 如果：index=-1 时，表示都没结束，取前 4 个；hasNext=true<br>&lt;2. 如果：size-index&lt;=4 时，表示未结束的不多了，取后 4 个；hasNext=false<br>&lt;3. 否则：取 index、index+1、index+2、index+3；hasNext=true</li>
</ol>
<p><strong>示例代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最多展示 4 个场次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_SCENE_SIZE</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Result <span class="title function_">getResult</span><span class="params">(List&lt;SceneModel&gt; candidateSceneList)</span> &#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> candidateSceneList.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不足4场次全部返回</span></span><br><span class="line">        <span class="keyword">if</span> (size &lt;= MAX_SCENE_SIZE) &#123;</span><br><span class="line">            result.setHasNext(<span class="literal">false</span>);</span><br><span class="line">            result.setSceneList(candidateSceneList);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 多余4场次，按以下规则取</span></span><br><span class="line">        List&lt;SceneModel&gt; resultList;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取最后一个已结束的场次下标</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> getLastFinishedSceneIndex(candidateSceneList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 如果：index=-1 时，表示都没结束，取前4个；hasNext=true</span></span><br><span class="line">        <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">            resultList = candidateSceneList.subList(<span class="number">0</span>, MAX_SCENE_SIZE);</span><br><span class="line">            result.setSceneList(resultList);</span><br><span class="line">            result.setHasNext(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 如果：size-index&lt;=4 时，表示未结束的不多了，取后4个；hasNext=false</span></span><br><span class="line">        <span class="keyword">if</span> (size - index &lt;= MAX_SCENE_SIZE) &#123;</span><br><span class="line">            resultList = candidateSceneList.subList(size - MAX_SCENE_SIZE, size);</span><br><span class="line">            result.setSceneList(resultList);</span><br><span class="line">            result.setHasNext(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 否则：取index、index+1、index+2、index+3；hasNext=true</span></span><br><span class="line">        resultList = candidateSceneList.subList(index, index + MAX_SCENE_SIZE);</span><br><span class="line">        result.setSceneList(resultList);</span><br><span class="line">        result.setHasNext(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/developer/%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/developer/%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">开发流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-07 10:46:54" itemprop="dateCreated datePublished" datetime="2021-12-07T10:46:54+08:00">2021-12-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><p>需求分析的时候，逐个看需求文档，<br>将需求点罗列到思维导图上（便于统筹帷幄），标记关键点、风险点和注意事项<br>（有助记效果，与产品或其他同事交流沟通时，有的放矢）。</p>
</li>
<li><p>概要设计、详细设计（技术选型、）</p>
</li>
<li><p>分析现在代码和数据库对需求的已有支持（不要重新造轮子）。</p>
</li>
<li><p>设计数据库表和字段，设计包结构、类结构和主要方法（类似于列大纲）。</p>
</li>
<li><p>编写接口文档（不是一个人在作战）。</p>
</li>
<li><p>修改配置、开发具体代码，适应新需求。</p>
</li>
<li><p>设计和开发过程中，将数据库、配置等的变动以及上线时的注意事项列一个运维清单（以防上线过程出问题）。</p>
</li>
<li><p>自测，编写单元测试、Postman 测试。</p>
</li>
<li><p>代码优化，魔法数字、命名、结构、注释、算法、设计模式等。</p>
</li>
<li><p>联调。</p>
</li>
<li><p>提测和 bug 修复。</p>
</li>
<li><p>打勾运维清单上线。</p>
</li>
<li><p>项目沉淀、后期优化。</p>
</li>
</ol>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021831640">阿里等大厂的研发流程，进去前先了解一下 - SegmentFault 思否</a></li>
<li><img src="https://cdn.jsdelivr.net/gh/lyloou/img/%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B_20211216143312_2021-12-16-14-33-13.png" alt="开发流程_20211216143312_2021-12-16-14-33-13"></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/tool/postman/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/tool/postman/" class="post-title-link" itemprop="url">Postman</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-26 10:44:24" itemprop="dateCreated datePublished" datetime="2021-10-26T10:44:24+08:00">2021-10-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="设置-Header-中的-token"><a href="#设置-Header-中的-token" class="headerlink" title="设置 Header 中的 token"></a>设置 Header 中的 token</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pm.<span class="title function_">test</span>(<span class="string">&quot;Status code is 200&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  pm.<span class="property">response</span>.<span class="property">to</span>.<span class="property">have</span>.<span class="title function_">status</span>(<span class="number">200</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> r = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(responseBody);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> token = r.<span class="property">data</span>.<span class="property">token</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(token);</span><br><span class="line"></span><br><span class="line">pm.<span class="property">globals</span>.<span class="title function_">unset</span>(<span class="string">&quot;LoginToken&quot;</span>);</span><br><span class="line"></span><br><span class="line">pm.<span class="property">globals</span>.<span class="title function_">set</span>(<span class="string">&quot;LoginToken&quot;</span>, <span class="string">&quot;Bearer:&quot;</span> + token);</span><br></pre></td></tr></table></figure>

<h2 id="如何使用-Postman-对接口参数进行签名"><a href="#如何使用-Postman-对接口参数进行签名" class="headerlink" title="如何使用 Postman 对接口参数进行签名"></a><a target="_blank" rel="noopener" href="http://autuan.top/2019/08/28/how-to-sign-params-by-postman/">如何使用 Postman 对接口参数进行签名</a></h2><p>在 <code>Pre-request Script</code> 选项卡中添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前的请求路径</span></span><br><span class="line"><span class="keyword">var</span> url = pm.<span class="property">request</span>.<span class="property">url</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取环境变量</span></span><br><span class="line"><span class="keyword">const</span> client = pm.<span class="property">environment</span>.<span class="title function_">get</span>(<span class="string">&quot;client&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> reqVersion = pm.<span class="property">environment</span>.<span class="title function_">get</span>(<span class="string">&quot;reqVersion&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> sign = pm.<span class="property">environment</span>.<span class="title function_">get</span>(<span class="string">&quot;reqVersion&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将必填参数拼接到路径上</span></span><br><span class="line">url = url + <span class="string">&quot;&amp;client=&quot;</span> + client + <span class="string">&quot;&amp;reqVersion=&quot;</span> + reqVersion + <span class="string">&quot;&amp;sign=&quot;</span> + sign;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写url</span></span><br><span class="line">pm.<span class="property">request</span>.<span class="property">url</span> = url;</span><br></pre></td></tr></table></figure>

<h2 id="SHA256-签名示例"><a href="#SHA256-签名示例" class="headerlink" title="SHA256 签名示例"></a>SHA256 签名示例</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前的请求路径</span></span><br><span class="line"><span class="keyword">var</span> url = pm.<span class="property">request</span>.<span class="property">url</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置参数</span></span><br><span class="line"><span class="keyword">let</span> activeId = <span class="string">&quot;2197&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> awardId = <span class="number">10266</span>;</span><br><span class="line"><span class="keyword">let</span> cOpenId = <span class="string">&quot;aaaa&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable constant_">MAC</span> = <span class="string">&quot;001a9a000000&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> cUDID = <span class="string">&quot;23320005&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> accessToken = <span class="string">&quot;bbb&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> cChip = <span class="string">&quot;ccc&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> cEmmcCID = <span class="string">&quot;ddd&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> cModel = <span class="string">&quot;eee&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 签名</span></span><br><span class="line"><span class="keyword">let</span> signStr = <span class="string">`MAC=<span class="subst">$&#123;MAC&#125;</span>&amp;accessToken=<span class="subst">$&#123;accessToken&#125;</span>&amp;cChip=<span class="subst">$&#123;cChip&#125;</span>&amp;cEmmcCID=<span class="subst">$&#123;cEmmcCID&#125;</span>&amp;cModel=<span class="subst">$&#123;cModel&#125;</span>&amp;cOpenId=<span class="subst">$&#123;cOpenId&#125;</span>&amp;cUDID=<span class="subst">$&#123;cUDID&#125;</span>&amp;id=<span class="subst">$&#123;activeId&#125;</span>&amp;source=wechat`</span>;</span><br><span class="line"><span class="keyword">var</span> sign = <span class="title class_">CryptoJS</span>.<span class="title class_">SHA256</span>(signStr).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将必填参数拼接到路径上</span></span><br><span class="line">url = <span class="string">`<span class="subst">$&#123;url&#125;</span>?activeId=<span class="subst">$&#123;activeId&#125;</span>&amp;awardId=<span class="subst">$&#123;awardId&#125;</span>&amp;cOpenId=<span class="subst">$&#123;cOpenId&#125;</span>&amp;MAC=<span class="subst">$&#123;MAC&#125;</span>&amp;cUDID=<span class="subst">$&#123;cUDID&#125;</span>&amp;accessToken=<span class="subst">$&#123;accessToken&#125;</span>&amp;&amp;token=<span class="subst">$&#123;sign&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写url</span></span><br><span class="line">pm.<span class="property">request</span>.<span class="property">url</span> = url;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">【算法】二分查找算法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-09 20:58:00" itemprop="dateCreated datePublished" datetime="2021-10-09T20:58:00+08:00">2021-10-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="二分查找"><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二分查找，从有序的数组中找到目标值</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinarySearch</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;找-1的下标：&quot;</span> + bSearch(arr, -<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找1的下标：&quot;</span> + bSearch(arr, <span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找2的下标：&quot;</span> + bSearch(arr, <span class="number">2</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找3的下标：&quot;</span> + bSearch(arr, <span class="number">3</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找4的下标：&quot;</span> + bSearch(arr, <span class="number">4</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找5的下标：&quot;</span> + bSearch(arr, <span class="number">5</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找6的下标：&quot;</span> + bSearch(arr, <span class="number">6</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找7的下标：&quot;</span> + bSearch(arr, <span class="number">7</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找8的下标：&quot;</span> + bSearch(arr, <span class="number">8</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找9的下标：&quot;</span> + bSearch(arr, <span class="number">9</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;找10的下标：&quot;</span> + bSearch(arr, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;从null中找1的下标：&quot;</span> + bSearch(<span class="literal">null</span>, <span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;从&#123;&#125;中找1的下标：&quot;</span> + bSearch(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;&#125;, <span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;从&#123;1&#125;找1的下标：&quot;</span> + bSearch(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>&#125;, <span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;从&#123;1&#125;找2的下标：&quot;</span> + bSearch(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>&#125;, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">bSearch</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">last</span> <span class="operator">=</span> arr.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (first &lt;= last) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 取中间值</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (first + last) &gt;&gt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (arr[mid] == target) &#123; <span class="comment">// 中间值正好是要找的目标值</span></span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arr[mid] &gt; target) &#123; <span class="comment">// 中间值大于目标值，在左边找</span></span><br><span class="line">                last = mid - <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 中间值小于目标值，在右边找</span></span><br><span class="line">                first = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">/* 输出：</span></span><br><span class="line"><span class="comment">找-1的下标：-1</span></span><br><span class="line"><span class="comment">找1的下标：0</span></span><br><span class="line"><span class="comment">找2的下标：1</span></span><br><span class="line"><span class="comment">找3的下标：2</span></span><br><span class="line"><span class="comment">找4的下标：3</span></span><br><span class="line"><span class="comment">找5的下标：4</span></span><br><span class="line"><span class="comment">找6的下标：5</span></span><br><span class="line"><span class="comment">找7的下标：6</span></span><br><span class="line"><span class="comment">找8的下标：7</span></span><br><span class="line"><span class="comment">找9的下标：8</span></span><br><span class="line"><span class="comment">找10的下标：-1</span></span><br><span class="line"><span class="comment">从null中找1的下标：-1</span></span><br><span class="line"><span class="comment">从&#123;&#125;中找1的下标：-1</span></span><br><span class="line"><span class="comment">从&#123;1&#125;找1的下标：0</span></span><br><span class="line"><span class="comment">从&#123;1&#125;找2的下标：-1</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="旋转数组的最小数字"><a href="#旋转数组的最小数字" class="headerlink" title="旋转数组的最小数字"></a>旋转数组的最小数字</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 有一个长度为 n 的非降序数组，比如[1,2,3,4,5]，将它进行旋转，即把一个数组最开始的若干个元素搬到数组的末尾，变成一个旋转数组，比如变成了[3,4,5,1,2]，或者[4,5,1,2,3]，</span></span><br><span class="line"><span class="comment"> * 这样的。请问，给定这样一个旋转数组，求数组中的最小值。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinaryExtendSearch</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;&#123;5, 6, 7, 8, 9, 1, 2, 3, 4&#125; 找最小值，应该是1：&quot;</span> + bExtendSearch(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;));</span><br><span class="line">        System.out.println(<span class="string">&quot;&#123;1, 2, 3, 4&#125;找最小值，应该是1：&quot;</span> + bExtendSearch(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;));</span><br><span class="line">        System.out.println(<span class="string">&quot;&#123;1, 0, 1, 1, 1&#125;找最小值，应该是0：&quot;</span> + bExtendSearch(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;));</span><br><span class="line">        System.out.println(<span class="string">&quot;&#123;1, 1, 1, 1, 1&#125;找最小值，应该是1：&quot;</span> + bExtendSearch(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">bExtendSearch</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取最右端数据为目标值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> arr[arr.length - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">first</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">last</span> <span class="operator">=</span> arr.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (first &lt; last) &#123;</span><br><span class="line">            <span class="comment">// 提前结束</span></span><br><span class="line">            <span class="keyword">if</span> (arr[first] &lt; arr[last]) &#123;</span><br><span class="line">                <span class="keyword">return</span> arr[first];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 取中值</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (first + last) &gt;&gt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果中间值大于目标值，最小值在右边</span></span><br><span class="line">            <span class="keyword">if</span> (arr[mid] &gt; target) &#123;</span><br><span class="line">                first = mid + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果中间值小于目标值，最小值在左边，目标值成为中间值</span></span><br><span class="line">            <span class="keyword">if</span> (arr[mid] &lt; target) &#123;</span><br><span class="line">                last = mid;</span><br><span class="line">                target = arr[mid];</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 其它情况，中间值==目标值</span></span><br><span class="line">            last--;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> arr[first];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">/*输出</span></span><br><span class="line"><span class="comment">&#123;5, 6, 7, 8, 9, 1, 2, 3, 4&#125; 找最小值，应该是1：1</span></span><br><span class="line"><span class="comment">&#123;1, 2, 3, 4&#125;找最小值，应该是1：1</span></span><br><span class="line"><span class="comment">&#123;1, 0, 1, 1, 1&#125;找最小值，应该是0：0</span></span><br><span class="line"><span class="comment">&#123;1, 1, 1, 1, 1&#125;找最小值，应该是1：1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/sql/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/sql/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA/" class="post-title-link" itemprop="url">数据库理论</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-09 14:05:06" itemprop="dateCreated datePublished" datetime="2021-09-09T14:05:06+08:00">2021-09-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="三范式"><a href="#三范式" class="headerlink" title="三范式"></a>三范式</h2><p>第一范式：消除属性值可再分（非原子的）；<br>第二范式：消除非主属性对候选键的部分依赖。<br>第三范式：消除非主属性对候选键的传递依赖。<br>BC 范式：消除主属性对候选键的部分依赖和传递依赖。</p>
<p><img src="http://cdn.lyloou.com/img/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA-2021-09-09-14-08-58.png" alt="数据库理论-2021-09-09-14-08-58"></p>
<p><strong>分析</strong></p>
<blockquote>
<p>假设有属性集：{A、B、C、D、E、J}<br>依赖集 {A-&gt;B, A-&gt;C, C-&gt;D, AJ-&gt;E}</p>
</blockquote>
<ul>
<li>候选键：<code>AJ</code></li>
<li>主属性：<code>A、J</code></li>
<li>非主属性：<code>B、C、D、E</code></li>
</ul>
<ul>
<li><code>AJ</code>是主属性，B 可以通过<code>A</code>确定，存在<code>非主属性对候选键的部分依赖</code>；<code>AJ-&gt;E</code>这个关系拆分后，可满足<code>第二范式</code>；</li>
<li><code>A-&gt;C，C-&gt;D</code>，存在<code>非主属性对候选键的传递依赖</code>；<code>C-D</code> 拆分后满足<code>第三范式</code>；</li>
</ul>
<p>对于 BC 范式，可以从下面图来理解<br><img src="http://cdn.lyloou.com/img/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA-2021-09-09-14-19-18.png" alt="数据库理论-2021-09-09-14-19-18"></p>
<p>例题（答案：C、A）：<br><img src="http://cdn.lyloou.com/img/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA-2021-09-09-14-20-23.png" alt="数据库理论-2021-09-09-14-20-23"></p>
<h2 id="多版本控制（MVCC）"><a href="#多版本控制（MVCC）" class="headerlink" title="多版本控制（MVCC）"></a>多版本控制（MVCC）</h2><p>读取优化策略，不使用锁，而是使用多个版本共存的思想，根据隔离级别确定使用哪个版本号。</p>
<p>版本号的创建规则是：</p>
<p>插入数据时：<code>CREATE_VERSION</code> 记录下当前的事务ID（事务 ID 是一个全局严格递增的数值），<code>DELETE_VERSION</code> 为空；</p>
<p>删除数据时：<code>CREATE_VERSION</code> 为空，<code>DELETE_VERSION</code> 为当前事务ID；</p>
<p>更新数据时：相当于“删除旧数据，插入新数据”，拷贝一份原始数据，将原始数据的 <code>CREATE_VERSION</code> 设为空，<code>DELETE_VERSION</code> 设为当前事务ID；再将拷贝后数据的 <code>CREATE_VERSION</code> 设为当前事务ID，<code>DELETE_VERSION</code> 设为空；</p>
<p>根据隔离级别确定使用哪个版本号：</p>
<p>如果隔离级别是<code>可重复读</code>：总是取 <code>CREATE_VERSION</code> 小于当前事务ID的记录，如果还存在多个版本，逆序取最新的一个；</p>
<p>如果隔离级别是<code>读已提交</code>：总是取最新commit了的版本；<br>参考资料：<a target="_blank" rel="noopener" href="https://icyfenix.cn/architect-perspective/general-architecture/transaction/local.html">本地事务 | 凤凰架构 (icyfenix.cn)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/business/Token%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/business/Token%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">基于 AOP 和 JWT 实现的 Token 身份认证组件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-13 15:20:05" itemprop="dateCreated datePublished" datetime="2021-08-13T15:20:05+08:00">2021-08-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><blockquote>
<p>基于 AOP 面向切面编程，在执行前后插入身份认证的逻辑。</p>
</blockquote>
<p><strong>原理细节：</strong></p>
<ul>
<li><p>登录过程：这个过程比较简单，将用户 id、用户名、过期时间等属性结合 jwt 工具生成 token，并将用户的信息存入到缓存中，以供后期使用。</p>
</li>
<li><p>验证过程：前端通过 Header 头信息的 Authorization 属性得到 Token，先进行 token 验证，再结合缓存验证，验证成功的话，将用户 id 和用户名等信息存入 <code>ThreadLocal</code> 中，这样在执行切面逻辑的时候。就可以从 <code>ThreadLocal</code> 中获取数据了，如<code>UserManager.getUserId()</code>；执行完成后需要清除 ThreadLocal 中的数据；代码如下</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ValidateLoginAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Around(&quot;pointCutMethod()&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">preHandle</span><span class="params">(ProceedingJoinPoint pjp)</span> &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    UserContextHolder.getInstance().setContext(userMap);</span><br><span class="line">    <span class="keyword">final</span> Object proceed;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      proceed = pjp.proceed();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      UserContextHolder.getInstance().clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> proceed;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>认证接口的范围：给 <code>BaseTokenController</code>这个基类添加 <code>@ValidateLogin</code>，<br>可以实现一个效果，只要自己的 <code>Controller</code> 继承了<code>BaseTokenController</code>，那么就不用再声明<code>@ValidateLogin</code>注解，自定义<code>Controller</code>中的 mapping 都需要身份认证。<br>（这样就免去了繁琐配置：在拦截器中通过通配符的方式配置哪些接口需要拦截，哪些接口需要放行）</li>
</ul>
<h2 id="服务端使用方式"><a href="#服务端使用方式" class="headerlink" title="服务端使用方式"></a>服务端使用方式</h2><p><strong>添加依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lyloou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>component-security-loginvalidator-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lyloou.component.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>继承<code>BaseTokenController</code>类。 因为这个类被<code>@ValidateLogin</code>标记，所以其下的所有子类都需要身份认证（具体实现细节，查看<code>ValidateLoginAspect</code>）。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> <span class="keyword">extends</span> <span class="title class_">BaseTokenController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从父类继承了ValidateLogin，需要身份验证</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/ping&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">ping</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> currentUserId();</span><br><span class="line">        System.out.println(userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pong&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>如果继承了 <code>BaseTokenController</code> 类，又希望其中的某个方法不要被拦截，可以在方法上标记 <code>@IgnoreValidateLogin</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> <span class="keyword">extends</span> <span class="title class_">BaseTokenController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 手动忽略身份验证</span></span><br><span class="line">    <span class="meta">@IgnoreValidateLogin</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String userId, String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">        map.put(<span class="string">&quot;userName&quot;</span>, username);</span><br><span class="line">        map.put(<span class="string">&quot;userAvatar&quot;</span>, <span class="string">&quot;http://cdn.lyloou.com/a.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> tokenService.createToken(userId, username, JSONUtil.toJsonStr(map));</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>如果没有继承 <code>BaseTokenController</code>，又希望在其中某个方法中做身份认证，获取用户 id，可以在方法上标记<code>@ValidateLogin</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 手动添加身份验证</span></span><br><span class="line">    <span class="meta">@ValidateLogin</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;userinfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(UserManager.X_USER_ID, UserManager.getUserId() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        map.put(UserManager.X_USER_IP, UserManager.getUserIP());</span><br><span class="line">        map.put(UserManager.X_USER_NAME, UserManager.getUserName());</span><br><span class="line">        map.put(UserManager.X_USER_INFO, UserManager.getUserInfo());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用自定义的缓存"><a href="#使用自定义的缓存" class="headerlink" title="使用自定义的缓存"></a>使用自定义的缓存</h2><p>默认使用了内存缓存<code>ConcurrentHashMap</code>（单机版本的）</p>
<p>也可以自定义缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lilou</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021/7/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisCodeCache</span> <span class="keyword">implements</span> <span class="title class_">DataCache</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisService redisService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenProperties tokenProperties</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        set(key, value, tokenProperties.getExpireSecond());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value, <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">        redisService.set(key, value, (<span class="type">int</span>) timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisService.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        redisService.del(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisService.exists(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="客户端使用"><a href="#客户端使用" class="headerlink" title="客户端使用"></a>客户端使用</h2><p>在 Header 中配置身份认证 Token 的信息：<br>如：<code>Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2Mjg4MzQ3MjQsImV4cCI6MTYyOTQzOTUyNCwieC11c2VyLW5hbWUiOiJhYmNkZSIsIngtdXNlci1pZCI6IjEifQ.x0nIhSUPfxC5FlnzJ-MmJvLnJv7w5ZvFzGlNphdSByE</code></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>登录接口：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/20210813155146.png" alt="image-20210813155138945"></p>
<p>获取用户信息接口：</p>
<p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/img/20210813155327.png" alt="image-20210813155327715"></p>
<h2 id="源码实现"><a href="#源码实现" class="headerlink" title="源码实现"></a>源码实现</h2><p><a target="_blank" rel="noopener" href="https://github.com/lyloou/component/tree/master/component-security-loginvalidator-starter">component/component-security-loginvalidator-starter at master · lyloou/component</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/business/%E7%AD%BE%E5%90%8D%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/business/%E7%AD%BE%E5%90%8D%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">接口签名校验设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-15 19:49:23" itemprop="dateCreated datePublished" datetime="2021-07-15T19:49:23+08:00">2021-07-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="签名目的"><a href="#签名目的" class="headerlink" title="签名目的"></a>签名目的</h2><ul>
<li>防篡改</li>
<li>防抓包</li>
<li>防刷</li>
<li>更安全</li>
</ul>
<h2 id="签名的主要防御措施："><a href="#签名的主要防御措施：" class="headerlink" title="签名的主要防御措施："></a>签名的主要防御措施：</h2><p>一、 验证签名</p>
<blockquote>
<p>将有效的参数按字典排序，并 md5 或 sha 加密（可以自定义加密算法）得到 param_sign，服务端依据同样的算法得到 server_sign，对比传递过来的 param_sign，不相等断定签名无效。<br>如果请求是 RequestBody ，当作 key 为 “body” ，value 为 json 字符串值传入校验。</p>
</blockquote>
<p>二、 请求的时间是否在限制的时间内（如：1 分钟内）</p>
<blockquote>
<p>判断请求的时间戳是否在允许的范围内</p>
</blockquote>
<p>三、 请求方是否被接口服务注册登记</p>
<blockquote>
<p>判断 clientId 是否有效</p>
</blockquote>
<p>四、 是否重复请求</p>
<blockquote>
<p>通过缓存验证 key (由 clientId+nonce 组成)是否已经存在，nonce 是随机生成的字符串<br>默认开启此功能，并由本地来缓存，可以自定义缓存实现微服务的场景（如 redis 等等）。</p>
</blockquote>
<h2 id="WIKI-文档"><a href="#WIKI-文档" class="headerlink" title="WIKI 文档"></a>WIKI 文档</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/lyloou/component/blob/master/component-security-signvalidator-starter/doc/1.1%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.md">1.1 服务端基本使用</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lyloou/component/blob/master/component-security-signvalidator-starter/doc/1.2%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.md">1.2 客户端基本使用</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lyloou/component/blob/master/component-security-signvalidator-starter/doc/2.%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E.md">2.配置说明</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lyloou/component/blob/master/component-security-signvalidator-starter/doc/3.%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%AD%98.md">3.自定义缓存</a></li>
<li><a href="doc/4.%E8%87%AA%E5%AE%9A%E4%B9%89%E9%AA%8C%E8%AF%81%E5%99%A8.md">4.自定义签名</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lyloou/component/blob/master/component-security-signvalidator-starter/doc/5.%E7%AD%BE%E5%90%8D%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7.md">5.签名异常捕获</a></li>
</ul>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>实现机制：通过拦截器，在真正 handler 之前，对请求拦截后统一处理。</p>
<p>我们可以继承 <code>HandlerInterceptorAdapter</code> 类，然后注册给 WebMvcConfigure，这样我们的拦截器就可以生效了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SignAutoConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">SignInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>签名的原理是：</p>
<ul>
<li>客户端将所有有效参数，将 key 按字典排序，加上密钥，然后 md5 加密得到 sign</li>
<li>服务端用同样的方式得到 sign，比较参数中的 sign 和自己生成的 sign</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>支持上面提到的所有防御措施</li>
<li>支持多客户端</li>
<li>支持自定义缓存</li>
<li>支持自定义验证器</li>
<li>支持全局和局部的开关控制</li>
</ul>
<h2 id="客户端工具"><a href="#客户端工具" class="headerlink" title="客户端工具"></a>客户端工具</h2><p><strong>Java 客户端工具</strong></p>
<blockquote>
<p>SimpleHttpUtil<br>具体见 <a target="_blank" rel="noopener" href="https://github.com/lyloou/component/blob/master/component-security-signvalidator-starter/doc/1.2%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.md">1.2 客户端基本使用</a></p>
</blockquote>
<p><strong>Js 客户端工具</strong></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/UzEsLtv_ald6Yw1XVAhmwg">再谈前后端 API 签名安全？</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ChwFubuX0HcB0DgIEi5Tog">前后端 API 交互如何保证数据安全性？</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_14888386/2515879">使用 nonce 巩固接口签名安全_猿天地的技术博客_51CTO 博客</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36641443/article/details/108475613">【AOP 实践】接口签名校验<em>Jayin</em>的博客-CSDN 博客</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/112555362">基于 Spring Boot 以及 Redis 使用 Aop 来实现 Api 接口签名验证 - 知乎</a></li>
</ul>
<h2 id="示例源码"><a href="#示例源码" class="headerlink" title="示例源码"></a>示例源码</h2><p><a target="_blank" rel="noopener" href="https://github.com/lyloou/component-parent-test/tree/master/component-security-signvalidator-starter-test">https://github.com/lyloou/component-parent-test/tree/master/component-security-signvalidator-starter-test</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/%E8%AF%BB%E6%BA%90%E7%A0%81/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%AF%BB%E6%BA%90%E7%A0%81/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">Justauth源码学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-25 10:44:54" itemprop="dateCreated datePublished" datetime="2021-06-25T10:44:54+08:00">2021-06-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="JustAuth-简介"><a href="#JustAuth-简介" class="headerlink" title="JustAuth 简介"></a>JustAuth 简介</h2><blockquote>
<p>🏆Gitee 最有价值开源项目 🚀💯 小而全而美的第三方登录开源组件。目前已支持 Github、Gitee、微博、钉钉、百度、Coding、腾讯云开发者平台、OSChina、支付宝、QQ、微信、淘宝、Google、Facebook、抖音、领英、小米、微软、今日头条、Teambition、StackOverflow、Pinterest、人人、华为、企业微信、酷家乐、Gitlab、美团、饿了么、推特、飞书、京东、阿里云、喜马拉雅、Amazon、Slack 和 Line 等第三方平台的授权登录。 Login, so easy!<br>网址：<a target="_blank" rel="noopener" href="https://github.com/justauth/JustAuth">justauth/JustAuth</a></p>
</blockquote>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">1.1.  Roles</span><br><span class="line"></span><br><span class="line">   OAuth defines four roles:</span><br><span class="line"></span><br><span class="line">   resource owner</span><br><span class="line">      An entity capable of granting access to a protected resource.</span><br><span class="line">      <span class="keyword">When</span> the resource owner is a person, it is referred to as an</span><br><span class="line">      end-user.</span><br><span class="line"></span><br><span class="line">   resource server</span><br><span class="line">      The server hosting the protected resources, capable of accepting</span><br><span class="line">      and responding to protected resource requests using access tokens.</span><br><span class="line"></span><br><span class="line">   client</span><br><span class="line">      An application making protected resource requests on behalf of the</span><br><span class="line">      resource owner and with its authorization.  The term <span class="string">&quot;client&quot;</span> does</span><br><span class="line">      not imply any particular implementation characteristics (e.g.,</span><br><span class="line">      whether the application executes on a server, a desktop, or other</span><br><span class="line">      devices).</span><br><span class="line"></span><br><span class="line">   authorization server</span><br><span class="line">      The server issuing access tokens to the client after successfully</span><br><span class="line">      authenticating the resource owner and obtaining authorization.</span><br><span class="line"></span><br><span class="line">   The interaction between the authorization server and resource server</span><br><span class="line">   is beyond the scope of this specification.  The authorization server</span><br><span class="line">   may be the same server as the resource server or a separate entity.</span><br><span class="line">   A single authorization server may issue access tokens accepted by</span><br><span class="line">   multiple resource servers.</span><br><span class="line"></span><br><span class="line">1.2.  Protocol Flow</span><br><span class="line"></span><br><span class="line">     +--------+                               +---------------+</span><br><span class="line">     |<span class="string">        </span>|<span class="string">--(A)- Authorization Request -&gt;</span>|<span class="string">   Resource    </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Owner     </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">&lt;-(B)-- Authorization Grant ---</span>|<span class="string">               </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|<span class="string">--(C)-- Authorization Grant --&gt;</span>|<span class="string"> Authorization </span>|</span><br><span class="line">     |<span class="string"> Client </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">&lt;-(D)----- Access Token -------</span>|<span class="string">               </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|<span class="string">--(E)----- Access Token ------&gt;</span>|<span class="string">    Resource   </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">&lt;-(F)--- Protected Resource ---</span>|<span class="string">               </span>|</span><br><span class="line">     +--------+                               +---------------+</span><br><span class="line"></span><br><span class="line">                     Figure 1: Abstract Protocol Flow</span><br><span class="line"></span><br><span class="line">   The abstract OAuth 2.0 flow illustrated in Figure 1 describes the</span><br><span class="line">   interaction between the four roles and includes the following steps:</span><br><span class="line"></span><br><span class="line">   (A)  The client requests authorization from the resource owner.  The</span><br><span class="line">        authorization request can be made directly to the resource owner</span><br><span class="line">        (as shown), or preferably indirectly via the authorization</span><br><span class="line">        server as an intermediary.</span><br><span class="line">		用户打开客户端以后，客户端要求用户给予授权。</span><br><span class="line">   (B)  The client receives an authorization grant, which is a</span><br><span class="line">        credential representing the resource owner&#x27;s authorization,</span><br><span class="line">        expressed using one of four grant types defined in this</span><br><span class="line">        specification or using an extension grant type.  The</span><br><span class="line">        authorization grant type depends on the method used by the</span><br><span class="line">        client to request authorization and the types supported by the</span><br><span class="line">        authorization server.</span><br><span class="line">		用户同意给予客户端授权。</span><br><span class="line"></span><br><span class="line">   (C)  The client requests an access token by authenticating with the</span><br><span class="line">        authorization server and presenting the authorization grant.</span><br><span class="line">		客户端使用上一步获得的授权，向认证服务器申请令牌。</span><br><span class="line">   (D)  The authorization server authenticates the client and validates</span><br><span class="line">        the authorization grant, and if valid, issues an access token.</span><br><span class="line">		认证服务器对客户端进行认证以后，确认无误，同意发放令牌</span><br><span class="line"></span><br><span class="line">   (E)  The client requests the protected resource from the resource</span><br><span class="line">        server and authenticates by presenting the access token.</span><br><span class="line">		客户端使用令牌，向资源服务器申请获取资源。</span><br><span class="line">   (F)  The resource server validates the access token, and if valid,</span><br><span class="line">        serves the request.</span><br><span class="line">		资源服务器确认令牌无误，同意向客户端开放资源。</span><br><span class="line">https://datatracker.ietf.org/doc/html/rfc6749<span class="comment">#section-1.2</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.lyloou.com/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-06-29-17-22-17.png" alt="justauth源码学习-2021-06-29-17-22-17"></p>
<h2 id="从以下几个问题来看代码"><a href="#从以下几个问题来看代码" class="headerlink" title="从以下几个问题来看代码"></a>从以下几个问题来看代码</h2><h4 id="Q-如何集成多家的？"><a href="#Q-如何集成多家的？" class="headerlink" title="Q: 如何集成多家的？"></a>Q: 如何集成多家的？</h4><p>这一块，主要是工厂模式和模板模式的应用。</p>
<p>工厂模式</p>
<figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AuthRequestFactory<span class="function"><span class="keyword">#</span><span class="title">get</span><span class="params">(<span class="variable">String</span> <span class="variable">source</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>模板模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AuthDefaultRequest</span> <span class="keyword">implements</span> <span class="title class_">AuthRequest</span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> AuthToken <span class="title function_">getAccessToken</span><span class="params">(AuthCallback var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> AuthUser <span class="title function_">getUserInfo</span><span class="params">(AuthToken var1)</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.lyloou.com/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-06-29-17-10-59.png" alt="justauth源码学习-2021-06-29-17-10-59"></p>
<p><strong>针对授权、获取用户信息等操作，由具体的 source 类来实现</strong><br>因为都是基于 OAuth2 来实现的，所以都有 authorize 地址、accessToken 地址、userInfo 地址 等概念</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthSource</span> &#123;</span><br><span class="line">    String <span class="title function_">authorize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">accessToken</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">userInfo</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">revoke</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthException</span>(AuthResponseStatus.UNSUPPORTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthException</span>(AuthResponseStatus.UNSUPPORTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span> <span class="keyword">instanceof</span> Enum ? String.valueOf(<span class="built_in">this</span>) : <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AuthDefaultSource</span> <span class="keyword">implements</span> <span class="title class_">AuthSource</span> &#123;</span><br><span class="line">    GITHUB &#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://github.com/login/oauth/authorize&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">accessToken</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://github.com/login/oauth/access_token&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.github.com/user&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    WEIBO &#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/oauth2/authorize&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">accessToken</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/oauth2/access_token&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/2/users/show.json&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">revoke</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/oauth2/revokeoauth2&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>多家配置</strong><br>JustAuthProperties，其 type 是 map 类型的，可以自定义任意多个的 source。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">justauth:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">type:</span></span><br><span class="line">    <span class="attr">QQ:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="number">10</span><span class="string">**********6</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">1f7d08**********5b7**********29e</span></span><br><span class="line">      <span class="attr">redirect-uri:</span> <span class="string">http://x.lyloou.com/oauth/qq/callback</span></span><br><span class="line">      <span class="attr">union-id:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">WEIBO:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="number">10</span><span class="string">**********6</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">1f7d08**********5b7**********29e</span></span><br><span class="line">      <span class="attr">redirect-uri:</span> <span class="string">http://x.lyloou.com/oauth/weibo/callback</span></span><br></pre></td></tr></table></figure>

<h4 id="Q-State-缓存如何实现？"><a href="#Q-State-缓存如何实现？" class="headerlink" title="Q: State 缓存如何实现？"></a>Q: State 缓存如何实现？</h4><p><code>state</code> 是 用来保持授权会话流程完整性，防止 CSRF 攻击的安全的随机的参数，由开发者生成</p>
<p><strong>自动配置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// justauth-spring-boot-starter JustAuthStateCacheConfiguration</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(&#123;AuthStateCache.class&#125;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">        name = &#123;&quot;justauth.cache.type&quot;&#125;,</span></span><br><span class="line"><span class="meta">        havingValue = &quot;default&quot;,</span></span><br><span class="line"><span class="meta">        matchIfMissing = true  // 默认</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Default</span> &#123;</span><br><span class="line">        Default() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> AuthStateCache <span class="title function_">authStateCache</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> AuthDefaultStateCache.INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            JustAuthStateCacheConfiguration.log.debug(<span class="string">&quot;JustAuth 使用 默认缓存存储 state 数据&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">justauth:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">default</span></span><br><span class="line"><span class="string">```</span></span><br><span class="line"></span><br><span class="line"><span class="string">**实现**</span></span><br><span class="line"></span><br><span class="line"><span class="string">**清理**</span></span><br><span class="line"></span><br><span class="line"><span class="string">通过</span> <span class="string">ScheduledThreadPoolExecutor</span> <span class="string">每隔</span> <span class="string">AuthCacheConfig.timeout</span> <span class="string">来定时清理</span> <span class="string">CacheState</span></span><br><span class="line"></span><br><span class="line"><span class="string">```java</span></span><br><span class="line"><span class="string">public</span> <span class="string">void</span> <span class="string">schedulePrune(long</span> <span class="string">delay)</span> &#123;</span><br><span class="line">	<span class="string">AuthCacheScheduler.INSTANCE.schedule(this::pruneCache</span>, <span class="string">delay);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">public</span> <span class="string">enum</span> <span class="string">AuthCacheScheduler</span> &#123;</span><br><span class="line">    <span class="string">INSTANCE;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">private</span> <span class="string">AtomicInteger</span> <span class="string">cacheTaskNumber</span> <span class="string">=</span> <span class="string">new</span> <span class="string">AtomicInteger(1);</span></span><br><span class="line">    <span class="string">private</span> <span class="string">ScheduledExecutorService</span> <span class="string">scheduler;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">private</span> <span class="string">AuthCacheScheduler()</span> &#123;</span><br><span class="line">        <span class="string">this.create();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">private</span> <span class="string">void</span> <span class="string">create()</span> &#123;</span><br><span class="line">        <span class="string">this.shutdown();</span></span><br><span class="line">        <span class="string">this.scheduler</span> <span class="string">=</span> <span class="string">new</span> <span class="string">ScheduledThreadPoolExecutor(10</span>, <span class="string">(r)</span> <span class="string">-&gt;</span> &#123;</span><br><span class="line">            <span class="string">return</span> <span class="string">new</span> <span class="string">Thread(r</span>, <span class="string">String.format(&quot;JustAuth-Task-%s&quot;</span>, <span class="string">this.cacheTaskNumber.getAndIncrement()));</span></span><br><span class="line">        &#125;<span class="string">);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">shutdown()</span> &#123;</span><br><span class="line">        <span class="string">if</span> <span class="string">(null</span> <span class="type">!=</span> <span class="string">this.scheduler)</span> &#123;</span><br><span class="line">            <span class="string">this.scheduler.shutdown();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">schedule(Runnable</span> <span class="string">task</span>, <span class="string">long</span> <span class="string">delay)</span> &#123;</span><br><span class="line">        <span class="string">this.scheduler.scheduleAtFixedRate(task</span>, <span class="string">delay</span>, <span class="string">delay</span>, <span class="string">TimeUnit.MILLISECONDS);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Q-如何做到适配自有的-OAuth-服务？"><a href="#Q-如何做到适配自有的-OAuth-服务？" class="headerlink" title="Q: 如何做到适配自有的 OAuth 服务？"></a>Q: 如何做到适配自有的 OAuth 服务？</h4><p>和上面其他平台的一样，可以自定义来适配新的平台。</p>
<ol>
<li><p>继承 AuthSource，加入 authorize、accessToken、userInfo 地址</p>
</li>
<li><p>实现 AuthDefaultRequest，重写几个基本的 oauth 服务接口：getAccessToken、getUserInfo、authorize。</p>
</li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AuthRequest</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthMyGitlabRequest</span>(AuthConfig.builder()</span><br><span class="line">    .clientId(<span class="string">&quot;63398e403231d4aa7e856cf5413620d536a876cb94e8d10ced0d3191b5d1d246&quot;</span>)</span><br><span class="line">    .clientSecret(<span class="string">&quot;65b0eba68fff019e682e6755882a24dfdbf0a61be55de119cb8970320186c8eb&quot;</span>)</span><br><span class="line">    .redirectUri(<span class="string">&quot;http://127.0.0.1:8443/oauth/callback/mygitlab&quot;</span>)</span><br><span class="line">    .build())</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Q-如何支持自定义-Scope？"><a href="#Q-如何支持自定义-Scope？" class="headerlink" title="Q: 如何支持自定义 Scope？"></a>Q: 如何支持自定义 Scope？</h4><p><a target="_blank" rel="noopener" href="https://justauth.wiki/features/customize-scopes.html#%E8%87%AA%E5%AE%9A%E4%B9%89-scope-%E6%8E%A5%E5%85%A5-google-%E5%B9%B3%E5%8F%B0">自定义-scope-接入-google-平台</a></p>
<p><code>scope</code> 简单来说，就是申请得到某个（某些）范围的资源，超过此范围的资源限制访问。</p>
<blockquote>
<p>Scope is a mechanism in OAuth 2.0 to limit an application’s access to a user’s account. An application can request one or more scopes, this information is then presented to the user in the consent screen, and the access token issued to the application will be limited to the scopes granted.</p>
<p>—— 以上内容节选自<a target="_blank" rel="noopener" href="https://oauth.net/">oauth.net</a><a target="_blank" rel="noopener" href="https://oauth.net/"> (opens new window)</a></p>
</blockquote>
<p>提供 AuthScope 统一接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个平台 scope 类的统一接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yadong.zhang (yadong.zhang0415(a)gmail.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.15.7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthScope</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取字符串 &#123;<span class="doctag">@code</span> scope&#125;，对应为各平台实际使用的 &#123;<span class="doctag">@code</span> scope&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getScope</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前 &#123;<span class="doctag">@code</span> scope&#125; 是否为各平台默认启用的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDefault</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>各个平台实现此接口，如 google</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Google 平台 OAuth 授权范围</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yadong.zhang (yadong.zhang0415(a)gmail.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AuthGoogleScope</span> <span class="keyword">implements</span> <span class="title class_">AuthScope</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> scope&#125; 含义，以&#123;<span class="doctag">@code</span> description&#125; 为准</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    USER_OPENID(<span class="string">&quot;openid&quot;</span>, <span class="string">&quot;Associate you with your personal info on Google&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">    USER_EMAIL(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;View your email address&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">    USER_PROFILE(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;View your basic profile info&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">    USER_PHONENUMBERS_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.phonenumbers.read&quot;</span>, <span class="string">&quot;View your phone numbers&quot;</span>, <span class="literal">false</span>),</span><br><span class="line">    USER_ORGANIZATION_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.organization.read&quot;</span>, <span class="string">&quot;See your education, work history and org info&quot;</span>, <span class="literal">false</span>),</span><br><span class="line">    USER_GENDER_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.gender.read&quot;</span>, <span class="string">&quot;See your gender&quot;</span>, <span class="literal">false</span>),</span><br><span class="line">    USER_EMAILS_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.emails.read&quot;</span>, <span class="string">&quot;View your email addresses&quot;</span>, <span class="literal">false</span>),</span><br><span class="line"></span><br><span class="line">    USER_BIRTHDAY_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.birthday.read&quot;</span>, <span class="string">&quot;View your complete date of birth&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合流程图来说，（A）这里需要将 scope 带过去，进入授权页面。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+--------+                               +---------------+</span><br><span class="line">|<span class="string">        </span>|<span class="string">--(A)- Authorization Request -&gt;</span>|<span class="string">   Resource    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Owner     </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(B)-- Authorization Grant ---</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|<span class="string">--(C)-- Authorization Grant --&gt;</span>|<span class="string"> Authorization </span>|</span><br><span class="line">|<span class="string"> Client </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(D)----- Access Token -------</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|<span class="string">--(E)----- Access Token ------&gt;</span>|<span class="string">    Resource   </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(F)--- Protected Resource ---</span>|<span class="string">               </span>|</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>accounts.google.com<span class="regexp">/o/</span>oauth2<span class="regexp">/v2/</span>auth?response_type=code&amp;client_id=<span class="number">553817080137</span>-d1pe3asc115tfgo74l8me92dhg4ro9k1.apps.googleusercontent.com&amp;redirect_uri=http:<span class="regexp">//</span>x.lyloou.com<span class="regexp">/oauth/g</span>oogle/callback&amp;state=e829a5725ce69cf1ed7918337caba839&amp;access_type=offline&amp;scope=openid email profile&amp;prompt=select_account</span><br></pre></td></tr></table></figure>

<p>授权页面的链接是通过 <code>AuthDefaultRequest.authorize</code> 来拼接得到的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthDefaultRequest.java</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回带&#123;<span class="doctag">@code</span> state&#125;参数的授权url，授权回调时会带上这个&#123;<span class="doctag">@code</span> state&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state state 验证授权流程的参数，可以防止csrf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回授权地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.9.3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">(String state)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UrlBuilder.fromBaseUrl(<span class="built_in">super</span>.authorize(state))</span><br><span class="line">            .queryParam(<span class="string">&quot;access_type&quot;</span>, <span class="string">&quot;offline&quot;</span>)</span><br><span class="line">            .queryParam(<span class="string">&quot;scope&quot;</span>, <span class="built_in">this</span>.getScopes(<span class="string">&quot; &quot;</span>, <span class="literal">false</span>, AuthScopeUtils.getDefaultScopes(AuthGoogleScope.values())))</span><br><span class="line">            .queryParam(<span class="string">&quot;prompt&quot;</span>,<span class="string">&quot;select_account&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取以 &#123;<span class="doctag">@code</span> separator&#125;分割过后的 scope 信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> separator     多个 &#123;<span class="doctag">@code</span> scope&#125; 间的分隔符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encode        是否 encode 编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultScopes 默认的 scope， 当客户端没有配置 &#123;<span class="doctag">@code</span> scopes&#125; 时启用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.16.7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getScopes</span><span class="params">(String separator, <span class="type">boolean</span> encode, List&lt;String&gt; defaultScopes)</span> &#123;</span><br><span class="line">        List&lt;String&gt; scopes = config.getScopes();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == scopes || scopes.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == defaultScopes || defaultScopes.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            scopes = defaultScopes;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == separator) &#123;</span><br><span class="line">            <span class="comment">// 默认为空格</span></span><br><span class="line">            separator = <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">scopeStr</span> <span class="operator">=</span> String.join(separator, scopes);</span><br><span class="line">        <span class="keyword">return</span> encode ? UrlUtil.urlEncode(scopeStr) : scopeStr;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>getScopes</code> 这里的逻辑是，如果没有传入 scope 参数，那么就使用默认的 scope 参数，即<code>openid email profile</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">USER_OPENID(<span class="string">&quot;openid&quot;</span>, <span class="string">&quot;Associate you with your personal info on Google&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">USER_EMAIL(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;View your email address&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">USER_PROFILE(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;View your basic profile info&quot;</span>, <span class="literal">true</span>),</span><br></pre></td></tr></table></figure>

<p>插曲：如果你把 email 和 profile 取消掉，获取到用户信息时会发现少了 email,profile 这些信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scope=openid</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">2000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;113911973270419053931&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;blog&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;company&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GOOGLE&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;accessToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ya29.a0ARrdaM-dddddd-MPjpVj6xJAJP0zZFb396tpmi6BkS_Uom1G7DGTvSaWdJwwOzCXC5Bus-xQjq9JdGfNKWylhl029LMtuyZVT7lKzquGvUFePmellmRoY2Or6RgjS-TwKHzSviQoqEFBcYlQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;expireIn&quot;</span><span class="punctuation">:</span> <span class="number">3592</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshTokenExpireIn&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;openId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accessCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;unionId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openid&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tokenType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;idToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJSUzI1NiIsImtpZCI6ImI2ZjhkNTVkYTUzNGVhOTFjYjJjYjAwZTFhZjRlOGUwY2RlY2E5M2QiLCJ0eXAiOiJKV1QifQ.dddddd.yYUcU9VMwrF3vGXfmR4bsJDeQSjl_msow9eCARiV8HYIyjWDyZUM0ihOqxQzunWUT0W3nRVWxFw4oeN9bhZxIU9jBpW600eJRyDZ6BgJs0QEmC4sjJ4rWPp_P6OFo6b4HEM9Cl5i4ix-cJV18-4BxWhM6WbuC09F3a5RVvp7YGzYhMDRK4fecDpy-7q5wFZws3oYOrjCK5rVu4lioLMTJHCV-THbWImZTrEiuiLxw6onvKwhDa2FfLGbO3tei0EoVTvxJJwi18K-5TzcNySb8yBA-NYTXmlLZ9iWb7NNa7IXqKI1qt0VYm7xUUY4r3G14tZKU6JKkuz07RVx-4zxMw&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macAlgorithm&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macKey&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthTokenSecret&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;screenName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthCallbackConfirmed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rawUserInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ddd&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;picture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scope=openid email profile</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">2000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;113911973270419053931&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lyloou6@gmail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lou&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;blog&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;company&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zh-CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lyloou6@gmail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GOOGLE&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;accessToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ya29.dd-dddd-eplbTCCWb55DHRZeAGDqDvk5RADufWREONGgKhdtCLa3yWKp4TxTJsyPi2EXYhgmMqV4yVV-NX6swbc38hMXKKGzsTnW4UVaiSOklQ-C1B_af&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;expireIn&quot;</span><span class="punctuation">:</span> <span class="number">3599</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshTokenExpireIn&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;openId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accessCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;unionId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openid https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tokenType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;idToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dddddddddd&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macAlgorithm&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macKey&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthTokenSecret&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;screenName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthCallbackConfirmed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rawUserInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;113911973270419053931&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email_verified&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lou&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;given_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lou&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;locale&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zh-CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;picture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lyloou6@gmail.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-07-02-10-50-48.png" alt="justauth源码学习-2021-07-02-10-50-48"><br>后面获取用户信息，带上 accessToken 来就可以获取了。</p>
<h4 id="Q-http-工具如何解耦，可以将选择权交给开发者？"><a href="#Q-http-工具如何解耦，可以将选择权交给开发者？" class="headerlink" title="Q: http 工具如何解耦，可以将选择权交给开发者？"></a>Q: http 工具如何解耦，可以将选择权交给开发者？</h4><p>作者引入了自己实现的 <code>simple-http</code> 工具包 <a target="_blank" rel="noopener" href="https://github.com/xkcoding/simple-http">xkcoding/simple-http: 抽取一个简单 HTTP 的通用接口，底层实现根据具体引入依赖指定。</a></p>
<p>从 <code>AuthGithubRequest#getUserInfo</code> 开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AuthUser <span class="title function_">getUserInfo</span><span class="params">(AuthToken authToken)</span> &#123;</span><br><span class="line">    <span class="type">HttpHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeader</span>();</span><br><span class="line">    header.add(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;token &quot;</span> + authToken.getAccessToken());</span><br><span class="line">    <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> (<span class="keyword">new</span> <span class="title class_">HttpUtils</span>(<span class="built_in">this</span>.config.getHttpConfig())).get(UrlBuilder.fromBaseUrl(<span class="built_in">this</span>.source.userInfo()).build(), (Map)<span class="literal">null</span>, header, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> JSONObject.parseObject(response);</span><br><span class="line">    <span class="built_in">this</span>.checkResponse(object.containsKey(<span class="string">&quot;error&quot;</span>), object.getString(<span class="string">&quot;error_description&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> AuthUser.builder().rawUserInfo(object).uuid(object.getString(<span class="string">&quot;id&quot;</span>)).username(object.getString(<span class="string">&quot;login&quot;</span>)).avatar(object.getString(<span class="string">&quot;avatar_url&quot;</span>)).blog(object.getString(<span class="string">&quot;blog&quot;</span>)).nickname(object.getString(<span class="string">&quot;name&quot;</span>)).company(object.getString(<span class="string">&quot;company&quot;</span>)).location(object.getString(<span class="string">&quot;location&quot;</span>)).email(object.getString(<span class="string">&quot;email&quot;</span>)).remark(object.getString(<span class="string">&quot;bio&quot;</span>)).gender(AuthUserGender.UNKNOWN).token(authToken).source(<span class="built_in">this</span>.source.toString()).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里实例化了一个 HttpUtils 工具类 <code>new HttpUtils(this.config.getHttpConfig())</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpUtils</span><span class="params">(HttpConfig config)</span> &#123;</span><br><span class="line">        HttpUtil.setConfig(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpUtil</span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConfig</span><span class="params">(HttpConfig httpConfig)</span> &#123;</span><br><span class="line">		checkHttpNotNull(proxy);</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == httpConfig) &#123;</span><br><span class="line">			httpConfig = HttpConfig.builder().timeout(Constants.DEFAULT_TIMEOUT).build();</span><br><span class="line">		&#125;</span><br><span class="line">		proxy.setHttpConfig(httpConfig);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkHttpNotNull</span><span class="params">(Http proxy)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == proxy) &#123;</span><br><span class="line">			selectHttpProxy();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到 <code>selectHttpProxy()</code>这里是关键，通过 <code>ClassUtil.isPresent</code>的方式（即<code>Class.forName</code>）来确定 class 是否可以被加载，从上到下，如果可以被加载，就作为 http 的具体代理。（所以引入了相关的 http 依赖，<code>HttpUtils</code> 就可以直接拿来使用了）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpUtil</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> AbstractHttp proxy;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">selectHttpProxy</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">AbstractHttp</span> <span class="variable">defaultProxy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> HttpUtil.class.getClassLoader();</span><br><span class="line">		<span class="comment">// 基于 java 11 HttpClient</span></span><br><span class="line">		<span class="keyword">if</span> (ClassUtil.isPresent(<span class="string">&quot;java.net.http.HttpClient&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.java11.HttpClientImpl.class);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 基于 okhttp3</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == defaultProxy &amp;&amp; ClassUtil.isPresent(<span class="string">&quot;okhttp3.OkHttpClient&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.okhttp3.OkHttp3Impl.class);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 基于 httpclient</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == defaultProxy &amp;&amp; ClassUtil.isPresent(<span class="string">&quot;org.apache.http.impl.client.HttpClients&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.httpclient.HttpClientImpl.class);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 基于 hutool</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == defaultProxy &amp;&amp; ClassUtil.isPresent(<span class="string">&quot;cn.hutool.http.HttpRequest&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.hutool.HutoolImpl.class);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (defaultProxy == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SimpleHttpException</span>(<span class="string">&quot;Has no HttpImpl defined in environment!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		proxy = defaultProxy;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下图，是 <code>simpleHttp</code> 默认支持的 Http 工具。</p>
<p><img src="http://cdn.lyloou.com/img/20210625112103.png" alt="image-20210625112056585"></p>
<p>也可以自己继承 <code>AbstractHttp</code>，然后调用 <code>HttpUtil#setHttp(AbstractHttp http)</code> 方法来接入自己实现的 http 工具。</p>
<p>所有实现 AbstractHttp 和 Http 的类，需要自己实现 一系列的<code>get</code>、 <code>post</code> 方法（即封装）。运行时通过面向对象中的多态来决定具体的实现者。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备18151128号 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lyloou</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>






  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"lyloou/lyloou.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkxMDk1NzkyNzA=","category":"Announcements","category_id":"DIC_kwDOBogMBs4CWdfR","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
