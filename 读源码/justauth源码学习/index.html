<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lyloou.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="JustAuth 简介 🏆Gitee 最有价值开源项目 🚀💯 小而全而美的第三方登录开源组件。目前已支持 Github、Gitee、微博、钉钉、百度、Coding、腾讯云开发者平台、OSChina、支付宝、QQ、微信、淘宝、Google、Facebook、抖音、领英、小米、微软、今日头条、Teambition、StackOverflow、Pinterest、人人、华为、企业微信、酷家乐、Gi">
<meta property="og:type" content="article">
<meta property="og:title" content="Justauth源码学习">
<meta property="og:url" content="https://lyloou.com/%E8%AF%BB%E6%BA%90%E7%A0%81/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="lyloou">
<meta property="og:description" content="JustAuth 简介 🏆Gitee 最有价值开源项目 🚀💯 小而全而美的第三方登录开源组件。目前已支持 Github、Gitee、微博、钉钉、百度、Coding、腾讯云开发者平台、OSChina、支付宝、QQ、微信、淘宝、Google、Facebook、抖音、领英、小米、微软、今日头条、Teambition、StackOverflow、Pinterest、人人、华为、企业微信、酷家乐、Gi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://cdn.lyloou.com/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-06-29-17-22-17.png">
<meta property="og:image" content="http://cdn.lyloou.com/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-06-29-17-10-59.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/lyloou/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-07-02-10-50-48.png">
<meta property="og:image" content="http://cdn.lyloou.com/img/20210625112103.png">
<meta property="article:published_time" content="2021-06-25T02:44:54.000Z">
<meta property="article:modified_time" content="2021-06-25T02:44:54.000Z">
<meta property="article:author" content="lyloou">
<meta property="article:tag" content="java">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cdn.lyloou.com/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-06-29-17-22-17.png">


<link rel="canonical" href="https://lyloou.com/%E8%AF%BB%E6%BA%90%E7%A0%81/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://lyloou.com/%E8%AF%BB%E6%BA%90%E7%A0%81/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/","path":"读源码/justauth源码学习/","title":"Justauth源码学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Justauth源码学习 | lyloou</title>
  
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-80542932-1","only_pageview":true}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">lyloou</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JustAuth-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">JustAuth 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E4%BB%A5%E4%B8%8B%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98%E6%9D%A5%E7%9C%8B%E4%BB%A3%E7%A0%81"><span class="nav-number">2.</span> <span class="nav-text">从以下几个问题来看代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Q-%E5%A6%82%E4%BD%95%E9%9B%86%E6%88%90%E5%A4%9A%E5%AE%B6%E7%9A%84%EF%BC%9F"><span class="nav-number">2.0.1.</span> <span class="nav-text">Q: 如何集成多家的？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q-State-%E7%BC%93%E5%AD%98%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%EF%BC%9F"><span class="nav-number">2.0.2.</span> <span class="nav-text">Q: State 缓存如何实现？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q-%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E9%80%82%E9%85%8D%E8%87%AA%E6%9C%89%E7%9A%84-OAuth-%E6%9C%8D%E5%8A%A1%EF%BC%9F"><span class="nav-number">2.0.3.</span> <span class="nav-text">Q: 如何做到适配自有的 OAuth 服务？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q-%E5%A6%82%E4%BD%95%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89-Scope%EF%BC%9F"><span class="nav-number">2.0.4.</span> <span class="nav-text">Q: 如何支持自定义 Scope？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q-http-%E5%B7%A5%E5%85%B7%E5%A6%82%E4%BD%95%E8%A7%A3%E8%80%A6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%B0%86%E9%80%89%E6%8B%A9%E6%9D%83%E4%BA%A4%E7%BB%99%E5%BC%80%E5%8F%91%E8%80%85%EF%BC%9F"><span class="nav-number">2.0.5.</span> <span class="nav-text">Q: http 工具如何解耦，可以将选择权交给开发者？</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lyloou"
      src="/assets/images/avatar.png">
  <p class="site-author-name" itemprop="name">lyloou</p>
  <div class="site-description" itemprop="description">/* Better than last best */</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">312</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/lyloou" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lyloou" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:lyloou6@gmail.com" title="E-Mail → mailto:lyloou6@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/lyloou" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;lyloou" rel="noopener me" target="_blank"><i class="weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/ly1414725328" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;ly1414725328" rel="noopener me" target="_blank"><i class="csdn fa-fw"></i>CSDN</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lyloou.com/%E8%AF%BB%E6%BA%90%E7%A0%81/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.png">
      <meta itemprop="name" content="lyloou">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyloou">
      <meta itemprop="description" content="/* Better than last best */">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Justauth源码学习 | lyloou">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Justauth源码学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-25 10:44:54" itemprop="dateCreated datePublished" datetime="2021-06-25T10:44:54+08:00">2021-06-25</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="JustAuth-简介"><a href="#JustAuth-简介" class="headerlink" title="JustAuth 简介"></a>JustAuth 简介</h2><blockquote>
<p>🏆Gitee 最有价值开源项目 🚀💯 小而全而美的第三方登录开源组件。目前已支持 Github、Gitee、微博、钉钉、百度、Coding、腾讯云开发者平台、OSChina、支付宝、QQ、微信、淘宝、Google、Facebook、抖音、领英、小米、微软、今日头条、Teambition、StackOverflow、Pinterest、人人、华为、企业微信、酷家乐、Gitlab、美团、饿了么、推特、飞书、京东、阿里云、喜马拉雅、Amazon、Slack 和 Line 等第三方平台的授权登录。 Login, so easy!<br>网址：<a target="_blank" rel="noopener" href="https://github.com/justauth/JustAuth">justauth/JustAuth</a></p>
</blockquote>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">1.1.  Roles</span><br><span class="line"></span><br><span class="line">   OAuth defines four roles:</span><br><span class="line"></span><br><span class="line">   resource owner</span><br><span class="line">      An entity capable of granting access to a protected resource.</span><br><span class="line">      <span class="keyword">When</span> the resource owner is a person, it is referred to as an</span><br><span class="line">      end-user.</span><br><span class="line"></span><br><span class="line">   resource server</span><br><span class="line">      The server hosting the protected resources, capable of accepting</span><br><span class="line">      and responding to protected resource requests using access tokens.</span><br><span class="line"></span><br><span class="line">   client</span><br><span class="line">      An application making protected resource requests on behalf of the</span><br><span class="line">      resource owner and with its authorization.  The term <span class="string">&quot;client&quot;</span> does</span><br><span class="line">      not imply any particular implementation characteristics (e.g.,</span><br><span class="line">      whether the application executes on a server, a desktop, or other</span><br><span class="line">      devices).</span><br><span class="line"></span><br><span class="line">   authorization server</span><br><span class="line">      The server issuing access tokens to the client after successfully</span><br><span class="line">      authenticating the resource owner and obtaining authorization.</span><br><span class="line"></span><br><span class="line">   The interaction between the authorization server and resource server</span><br><span class="line">   is beyond the scope of this specification.  The authorization server</span><br><span class="line">   may be the same server as the resource server or a separate entity.</span><br><span class="line">   A single authorization server may issue access tokens accepted by</span><br><span class="line">   multiple resource servers.</span><br><span class="line"></span><br><span class="line">1.2.  Protocol Flow</span><br><span class="line"></span><br><span class="line">     +--------+                               +---------------+</span><br><span class="line">     |<span class="string">        </span>|<span class="string">--(A)- Authorization Request -&gt;</span>|<span class="string">   Resource    </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Owner     </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">&lt;-(B)-- Authorization Grant ---</span>|<span class="string">               </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|<span class="string">--(C)-- Authorization Grant --&gt;</span>|<span class="string"> Authorization </span>|</span><br><span class="line">     |<span class="string"> Client </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">&lt;-(D)----- Access Token -------</span>|<span class="string">               </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string">     </span>|<span class="string">        </span>|<span class="string">--(E)----- Access Token ------&gt;</span>|<span class="string">    Resource   </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">     |<span class="string">        </span>|<span class="string">&lt;-(F)--- Protected Resource ---</span>|<span class="string">               </span>|</span><br><span class="line">     +--------+                               +---------------+</span><br><span class="line"></span><br><span class="line">                     Figure 1: Abstract Protocol Flow</span><br><span class="line"></span><br><span class="line">   The abstract OAuth 2.0 flow illustrated in Figure 1 describes the</span><br><span class="line">   interaction between the four roles and includes the following steps:</span><br><span class="line"></span><br><span class="line">   (A)  The client requests authorization from the resource owner.  The</span><br><span class="line">        authorization request can be made directly to the resource owner</span><br><span class="line">        (as shown), or preferably indirectly via the authorization</span><br><span class="line">        server as an intermediary.</span><br><span class="line">		用户打开客户端以后，客户端要求用户给予授权。</span><br><span class="line">   (B)  The client receives an authorization grant, which is a</span><br><span class="line">        credential representing the resource owner&#x27;s authorization,</span><br><span class="line">        expressed using one of four grant types defined in this</span><br><span class="line">        specification or using an extension grant type.  The</span><br><span class="line">        authorization grant type depends on the method used by the</span><br><span class="line">        client to request authorization and the types supported by the</span><br><span class="line">        authorization server.</span><br><span class="line">		用户同意给予客户端授权。</span><br><span class="line"></span><br><span class="line">   (C)  The client requests an access token by authenticating with the</span><br><span class="line">        authorization server and presenting the authorization grant.</span><br><span class="line">		客户端使用上一步获得的授权，向认证服务器申请令牌。</span><br><span class="line">   (D)  The authorization server authenticates the client and validates</span><br><span class="line">        the authorization grant, and if valid, issues an access token.</span><br><span class="line">		认证服务器对客户端进行认证以后，确认无误，同意发放令牌</span><br><span class="line"></span><br><span class="line">   (E)  The client requests the protected resource from the resource</span><br><span class="line">        server and authenticates by presenting the access token.</span><br><span class="line">		客户端使用令牌，向资源服务器申请获取资源。</span><br><span class="line">   (F)  The resource server validates the access token, and if valid,</span><br><span class="line">        serves the request.</span><br><span class="line">		资源服务器确认令牌无误，同意向客户端开放资源。</span><br><span class="line">https://datatracker.ietf.org/doc/html/rfc6749<span class="comment">#section-1.2</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.lyloou.com/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-06-29-17-22-17.png" alt="justauth源码学习-2021-06-29-17-22-17"></p>
<h2 id="从以下几个问题来看代码"><a href="#从以下几个问题来看代码" class="headerlink" title="从以下几个问题来看代码"></a>从以下几个问题来看代码</h2><h4 id="Q-如何集成多家的？"><a href="#Q-如何集成多家的？" class="headerlink" title="Q: 如何集成多家的？"></a>Q: 如何集成多家的？</h4><p>这一块，主要是工厂模式和模板模式的应用。</p>
<p>工厂模式</p>
<figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AuthRequestFactory<span class="function"><span class="keyword">#</span><span class="title">get</span><span class="params">(<span class="variable">String</span> <span class="variable">source</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>模板模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AuthDefaultRequest</span> <span class="keyword">implements</span> <span class="title class_">AuthRequest</span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> AuthToken <span class="title function_">getAccessToken</span><span class="params">(AuthCallback var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> AuthUser <span class="title function_">getUserInfo</span><span class="params">(AuthToken var1)</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.lyloou.com/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-06-29-17-10-59.png" alt="justauth源码学习-2021-06-29-17-10-59"></p>
<p><strong>针对授权、获取用户信息等操作，由具体的 source 类来实现</strong><br>因为都是基于 OAuth2 来实现的，所以都有 authorize 地址、accessToken 地址、userInfo 地址 等概念</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthSource</span> &#123;</span><br><span class="line">    String <span class="title function_">authorize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">accessToken</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">userInfo</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">revoke</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthException</span>(AuthResponseStatus.UNSUPPORTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthException</span>(AuthResponseStatus.UNSUPPORTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span> <span class="keyword">instanceof</span> Enum ? String.valueOf(<span class="built_in">this</span>) : <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AuthDefaultSource</span> <span class="keyword">implements</span> <span class="title class_">AuthSource</span> &#123;</span><br><span class="line">    GITHUB &#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://github.com/login/oauth/authorize&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">accessToken</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://github.com/login/oauth/access_token&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.github.com/user&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    WEIBO &#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/oauth2/authorize&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">accessToken</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/oauth2/access_token&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/2/users/show.json&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">revoke</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;https://api.weibo.com/oauth2/revokeoauth2&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>多家配置</strong><br>JustAuthProperties，其 type 是 map 类型的，可以自定义任意多个的 source。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">justauth:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">type:</span></span><br><span class="line">    <span class="attr">QQ:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="number">10</span><span class="string">**********6</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">1f7d08**********5b7**********29e</span></span><br><span class="line">      <span class="attr">redirect-uri:</span> <span class="string">http://x.lyloou.com/oauth/qq/callback</span></span><br><span class="line">      <span class="attr">union-id:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">WEIBO:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="number">10</span><span class="string">**********6</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">1f7d08**********5b7**********29e</span></span><br><span class="line">      <span class="attr">redirect-uri:</span> <span class="string">http://x.lyloou.com/oauth/weibo/callback</span></span><br></pre></td></tr></table></figure>

<h4 id="Q-State-缓存如何实现？"><a href="#Q-State-缓存如何实现？" class="headerlink" title="Q: State 缓存如何实现？"></a>Q: State 缓存如何实现？</h4><p><code>state</code> 是 用来保持授权会话流程完整性，防止 CSRF 攻击的安全的随机的参数，由开发者生成</p>
<p><strong>自动配置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// justauth-spring-boot-starter JustAuthStateCacheConfiguration</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(&#123;AuthStateCache.class&#125;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">        name = &#123;&quot;justauth.cache.type&quot;&#125;,</span></span><br><span class="line"><span class="meta">        havingValue = &quot;default&quot;,</span></span><br><span class="line"><span class="meta">        matchIfMissing = true  // 默认</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Default</span> &#123;</span><br><span class="line">        Default() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> AuthStateCache <span class="title function_">authStateCache</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> AuthDefaultStateCache.INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            JustAuthStateCacheConfiguration.log.debug(<span class="string">&quot;JustAuth 使用 默认缓存存储 state 数据&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">justauth:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">default</span></span><br><span class="line"><span class="string">```</span></span><br><span class="line"></span><br><span class="line"><span class="string">**实现**</span></span><br><span class="line"></span><br><span class="line"><span class="string">**清理**</span></span><br><span class="line"></span><br><span class="line"><span class="string">通过</span> <span class="string">ScheduledThreadPoolExecutor</span> <span class="string">每隔</span> <span class="string">AuthCacheConfig.timeout</span> <span class="string">来定时清理</span> <span class="string">CacheState</span></span><br><span class="line"></span><br><span class="line"><span class="string">```java</span></span><br><span class="line"><span class="string">public</span> <span class="string">void</span> <span class="string">schedulePrune(long</span> <span class="string">delay)</span> &#123;</span><br><span class="line">	<span class="string">AuthCacheScheduler.INSTANCE.schedule(this::pruneCache</span>, <span class="string">delay);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">public</span> <span class="string">enum</span> <span class="string">AuthCacheScheduler</span> &#123;</span><br><span class="line">    <span class="string">INSTANCE;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">private</span> <span class="string">AtomicInteger</span> <span class="string">cacheTaskNumber</span> <span class="string">=</span> <span class="string">new</span> <span class="string">AtomicInteger(1);</span></span><br><span class="line">    <span class="string">private</span> <span class="string">ScheduledExecutorService</span> <span class="string">scheduler;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">private</span> <span class="string">AuthCacheScheduler()</span> &#123;</span><br><span class="line">        <span class="string">this.create();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">private</span> <span class="string">void</span> <span class="string">create()</span> &#123;</span><br><span class="line">        <span class="string">this.shutdown();</span></span><br><span class="line">        <span class="string">this.scheduler</span> <span class="string">=</span> <span class="string">new</span> <span class="string">ScheduledThreadPoolExecutor(10</span>, <span class="string">(r)</span> <span class="string">-&gt;</span> &#123;</span><br><span class="line">            <span class="string">return</span> <span class="string">new</span> <span class="string">Thread(r</span>, <span class="string">String.format(&quot;JustAuth-Task-%s&quot;</span>, <span class="string">this.cacheTaskNumber.getAndIncrement()));</span></span><br><span class="line">        &#125;<span class="string">);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">shutdown()</span> &#123;</span><br><span class="line">        <span class="string">if</span> <span class="string">(null</span> <span class="type">!=</span> <span class="string">this.scheduler)</span> &#123;</span><br><span class="line">            <span class="string">this.scheduler.shutdown();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">schedule(Runnable</span> <span class="string">task</span>, <span class="string">long</span> <span class="string">delay)</span> &#123;</span><br><span class="line">        <span class="string">this.scheduler.scheduleAtFixedRate(task</span>, <span class="string">delay</span>, <span class="string">delay</span>, <span class="string">TimeUnit.MILLISECONDS);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Q-如何做到适配自有的-OAuth-服务？"><a href="#Q-如何做到适配自有的-OAuth-服务？" class="headerlink" title="Q: 如何做到适配自有的 OAuth 服务？"></a>Q: 如何做到适配自有的 OAuth 服务？</h4><p>和上面其他平台的一样，可以自定义来适配新的平台。</p>
<ol>
<li><p>继承 AuthSource，加入 authorize、accessToken、userInfo 地址</p>
</li>
<li><p>实现 AuthDefaultRequest，重写几个基本的 oauth 服务接口：getAccessToken、getUserInfo、authorize。</p>
</li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AuthRequest</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthMyGitlabRequest</span>(AuthConfig.builder()</span><br><span class="line">    .clientId(<span class="string">&quot;63398e403231d4aa7e856cf5413620d536a876cb94e8d10ced0d3191b5d1d246&quot;</span>)</span><br><span class="line">    .clientSecret(<span class="string">&quot;65b0eba68fff019e682e6755882a24dfdbf0a61be55de119cb8970320186c8eb&quot;</span>)</span><br><span class="line">    .redirectUri(<span class="string">&quot;http://127.0.0.1:8443/oauth/callback/mygitlab&quot;</span>)</span><br><span class="line">    .build())</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Q-如何支持自定义-Scope？"><a href="#Q-如何支持自定义-Scope？" class="headerlink" title="Q: 如何支持自定义 Scope？"></a>Q: 如何支持自定义 Scope？</h4><p><a target="_blank" rel="noopener" href="https://justauth.wiki/features/customize-scopes.html#%E8%87%AA%E5%AE%9A%E4%B9%89-scope-%E6%8E%A5%E5%85%A5-google-%E5%B9%B3%E5%8F%B0">自定义-scope-接入-google-平台</a></p>
<p><code>scope</code> 简单来说，就是申请得到某个（某些）范围的资源，超过此范围的资源限制访问。</p>
<blockquote>
<p>Scope is a mechanism in OAuth 2.0 to limit an application’s access to a user’s account. An application can request one or more scopes, this information is then presented to the user in the consent screen, and the access token issued to the application will be limited to the scopes granted.</p>
<p>—— 以上内容节选自<a target="_blank" rel="noopener" href="https://oauth.net/">oauth.net</a><a target="_blank" rel="noopener" href="https://oauth.net/"> (opens new window)</a></p>
</blockquote>
<p>提供 AuthScope 统一接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个平台 scope 类的统一接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yadong.zhang (yadong.zhang0415(a)gmail.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.15.7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthScope</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取字符串 &#123;<span class="doctag">@code</span> scope&#125;，对应为各平台实际使用的 &#123;<span class="doctag">@code</span> scope&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getScope</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前 &#123;<span class="doctag">@code</span> scope&#125; 是否为各平台默认启用的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDefault</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>各个平台实现此接口，如 google</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Google 平台 OAuth 授权范围</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yadong.zhang (yadong.zhang0415(a)gmail.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AuthGoogleScope</span> <span class="keyword">implements</span> <span class="title class_">AuthScope</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> scope&#125; 含义，以&#123;<span class="doctag">@code</span> description&#125; 为准</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    USER_OPENID(<span class="string">&quot;openid&quot;</span>, <span class="string">&quot;Associate you with your personal info on Google&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">    USER_EMAIL(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;View your email address&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">    USER_PROFILE(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;View your basic profile info&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">    USER_PHONENUMBERS_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.phonenumbers.read&quot;</span>, <span class="string">&quot;View your phone numbers&quot;</span>, <span class="literal">false</span>),</span><br><span class="line">    USER_ORGANIZATION_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.organization.read&quot;</span>, <span class="string">&quot;See your education, work history and org info&quot;</span>, <span class="literal">false</span>),</span><br><span class="line">    USER_GENDER_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.gender.read&quot;</span>, <span class="string">&quot;See your gender&quot;</span>, <span class="literal">false</span>),</span><br><span class="line">    USER_EMAILS_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.emails.read&quot;</span>, <span class="string">&quot;View your email addresses&quot;</span>, <span class="literal">false</span>),</span><br><span class="line"></span><br><span class="line">    USER_BIRTHDAY_READ(<span class="string">&quot;https://www.googleapis.com/auth/user.birthday.read&quot;</span>, <span class="string">&quot;View your complete date of birth&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合流程图来说，（A）这里需要将 scope 带过去，进入授权页面。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+--------+                               +---------------+</span><br><span class="line">|<span class="string">        </span>|<span class="string">--(A)- Authorization Request -&gt;</span>|<span class="string">   Resource    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Owner     </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(B)-- Authorization Grant ---</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|<span class="string">--(C)-- Authorization Grant --&gt;</span>|<span class="string"> Authorization </span>|</span><br><span class="line">|<span class="string"> Client </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(D)----- Access Token -------</span>|<span class="string">               </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               +---------------+</span></span><br><span class="line"><span class="string"></span>|<span class="string">        </span>|<span class="string">--(E)----- Access Token ------&gt;</span>|<span class="string">    Resource   </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">                               </span>|<span class="string">     Server    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">&lt;-(F)--- Protected Resource ---</span>|<span class="string">               </span>|</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>accounts.google.com<span class="regexp">/o/</span>oauth2<span class="regexp">/v2/</span>auth?response_type=code&amp;client_id=<span class="number">553817080137</span>-d1pe3asc115tfgo74l8me92dhg4ro9k1.apps.googleusercontent.com&amp;redirect_uri=http:<span class="regexp">//</span>x.lyloou.com<span class="regexp">/oauth/g</span>oogle/callback&amp;state=e829a5725ce69cf1ed7918337caba839&amp;access_type=offline&amp;scope=openid email profile&amp;prompt=select_account</span><br></pre></td></tr></table></figure>

<p>授权页面的链接是通过 <code>AuthDefaultRequest.authorize</code> 来拼接得到的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthDefaultRequest.java</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回带&#123;<span class="doctag">@code</span> state&#125;参数的授权url，授权回调时会带上这个&#123;<span class="doctag">@code</span> state&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state state 验证授权流程的参数，可以防止csrf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回授权地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.9.3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">(String state)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UrlBuilder.fromBaseUrl(<span class="built_in">super</span>.authorize(state))</span><br><span class="line">            .queryParam(<span class="string">&quot;access_type&quot;</span>, <span class="string">&quot;offline&quot;</span>)</span><br><span class="line">            .queryParam(<span class="string">&quot;scope&quot;</span>, <span class="built_in">this</span>.getScopes(<span class="string">&quot; &quot;</span>, <span class="literal">false</span>, AuthScopeUtils.getDefaultScopes(AuthGoogleScope.values())))</span><br><span class="line">            .queryParam(<span class="string">&quot;prompt&quot;</span>,<span class="string">&quot;select_account&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取以 &#123;<span class="doctag">@code</span> separator&#125;分割过后的 scope 信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> separator     多个 &#123;<span class="doctag">@code</span> scope&#125; 间的分隔符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encode        是否 encode 编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultScopes 默认的 scope， 当客户端没有配置 &#123;<span class="doctag">@code</span> scopes&#125; 时启用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.16.7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getScopes</span><span class="params">(String separator, <span class="type">boolean</span> encode, List&lt;String&gt; defaultScopes)</span> &#123;</span><br><span class="line">        List&lt;String&gt; scopes = config.getScopes();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == scopes || scopes.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == defaultScopes || defaultScopes.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            scopes = defaultScopes;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == separator) &#123;</span><br><span class="line">            <span class="comment">// 默认为空格</span></span><br><span class="line">            separator = <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">scopeStr</span> <span class="operator">=</span> String.join(separator, scopes);</span><br><span class="line">        <span class="keyword">return</span> encode ? UrlUtil.urlEncode(scopeStr) : scopeStr;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>getScopes</code> 这里的逻辑是，如果没有传入 scope 参数，那么就使用默认的 scope 参数，即<code>openid email profile</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">USER_OPENID(<span class="string">&quot;openid&quot;</span>, <span class="string">&quot;Associate you with your personal info on Google&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">USER_EMAIL(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;View your email address&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">USER_PROFILE(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;View your basic profile info&quot;</span>, <span class="literal">true</span>),</span><br></pre></td></tr></table></figure>

<p>插曲：如果你把 email 和 profile 取消掉，获取到用户信息时会发现少了 email,profile 这些信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scope=openid</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">2000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;113911973270419053931&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;blog&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;company&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GOOGLE&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;accessToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ya29.a0ARrdaM-dddddd-MPjpVj6xJAJP0zZFb396tpmi6BkS_Uom1G7DGTvSaWdJwwOzCXC5Bus-xQjq9JdGfNKWylhl029LMtuyZVT7lKzquGvUFePmellmRoY2Or6RgjS-TwKHzSviQoqEFBcYlQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;expireIn&quot;</span><span class="punctuation">:</span> <span class="number">3592</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshTokenExpireIn&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;openId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accessCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;unionId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openid&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tokenType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;idToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJSUzI1NiIsImtpZCI6ImI2ZjhkNTVkYTUzNGVhOTFjYjJjYjAwZTFhZjRlOGUwY2RlY2E5M2QiLCJ0eXAiOiJKV1QifQ.dddddd.yYUcU9VMwrF3vGXfmR4bsJDeQSjl_msow9eCARiV8HYIyjWDyZUM0ihOqxQzunWUT0W3nRVWxFw4oeN9bhZxIU9jBpW600eJRyDZ6BgJs0QEmC4sjJ4rWPp_P6OFo6b4HEM9Cl5i4ix-cJV18-4BxWhM6WbuC09F3a5RVvp7YGzYhMDRK4fecDpy-7q5wFZws3oYOrjCK5rVu4lioLMTJHCV-THbWImZTrEiuiLxw6onvKwhDa2FfLGbO3tei0EoVTvxJJwi18K-5TzcNySb8yBA-NYTXmlLZ9iWb7NNa7IXqKI1qt0VYm7xUUY4r3G14tZKU6JKkuz07RVx-4zxMw&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macAlgorithm&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macKey&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthTokenSecret&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;screenName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthCallbackConfirmed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rawUserInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ddd&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;picture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scope=openid email profile</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">2000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;113911973270419053931&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lyloou6@gmail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lou&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;blog&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;company&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zh-CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lyloou6@gmail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GOOGLE&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;accessToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ya29.dd-dddd-eplbTCCWb55DHRZeAGDqDvk5RADufWREONGgKhdtCLa3yWKp4TxTJsyPi2EXYhgmMqV4yVV-NX6swbc38hMXKKGzsTnW4UVaiSOklQ-C1B_af&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;expireIn&quot;</span><span class="punctuation">:</span> <span class="number">3599</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refreshTokenExpireIn&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;openId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;accessCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;unionId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;openid https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tokenType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;idToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dddddddddd&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macAlgorithm&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;macKey&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthToken&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthTokenSecret&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;screenName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;oauthCallbackConfirmed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rawUserInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;113911973270419053931&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email_verified&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lou&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;given_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lou&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;locale&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zh-CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;picture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://lh3.googleusercontent.com/a-/AOh14GgncI8eYK_uG119BDclub5LNGDn57G_GI4OLZeOBA=s96-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lyloou6@gmail.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/lyloou/img/justauth%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-2021-07-02-10-50-48.png" alt="justauth源码学习-2021-07-02-10-50-48"><br>后面获取用户信息，带上 accessToken 来就可以获取了。</p>
<h4 id="Q-http-工具如何解耦，可以将选择权交给开发者？"><a href="#Q-http-工具如何解耦，可以将选择权交给开发者？" class="headerlink" title="Q: http 工具如何解耦，可以将选择权交给开发者？"></a>Q: http 工具如何解耦，可以将选择权交给开发者？</h4><p>作者引入了自己实现的 <code>simple-http</code> 工具包 <a target="_blank" rel="noopener" href="https://github.com/xkcoding/simple-http">xkcoding/simple-http: 抽取一个简单 HTTP 的通用接口，底层实现根据具体引入依赖指定。</a></p>
<p>从 <code>AuthGithubRequest#getUserInfo</code> 开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AuthUser <span class="title function_">getUserInfo</span><span class="params">(AuthToken authToken)</span> &#123;</span><br><span class="line">    <span class="type">HttpHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeader</span>();</span><br><span class="line">    header.add(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;token &quot;</span> + authToken.getAccessToken());</span><br><span class="line">    <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> (<span class="keyword">new</span> <span class="title class_">HttpUtils</span>(<span class="built_in">this</span>.config.getHttpConfig())).get(UrlBuilder.fromBaseUrl(<span class="built_in">this</span>.source.userInfo()).build(), (Map)<span class="literal">null</span>, header, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> JSONObject.parseObject(response);</span><br><span class="line">    <span class="built_in">this</span>.checkResponse(object.containsKey(<span class="string">&quot;error&quot;</span>), object.getString(<span class="string">&quot;error_description&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> AuthUser.builder().rawUserInfo(object).uuid(object.getString(<span class="string">&quot;id&quot;</span>)).username(object.getString(<span class="string">&quot;login&quot;</span>)).avatar(object.getString(<span class="string">&quot;avatar_url&quot;</span>)).blog(object.getString(<span class="string">&quot;blog&quot;</span>)).nickname(object.getString(<span class="string">&quot;name&quot;</span>)).company(object.getString(<span class="string">&quot;company&quot;</span>)).location(object.getString(<span class="string">&quot;location&quot;</span>)).email(object.getString(<span class="string">&quot;email&quot;</span>)).remark(object.getString(<span class="string">&quot;bio&quot;</span>)).gender(AuthUserGender.UNKNOWN).token(authToken).source(<span class="built_in">this</span>.source.toString()).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里实例化了一个 HttpUtils 工具类 <code>new HttpUtils(this.config.getHttpConfig())</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpUtils</span><span class="params">(HttpConfig config)</span> &#123;</span><br><span class="line">        HttpUtil.setConfig(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpUtil</span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConfig</span><span class="params">(HttpConfig httpConfig)</span> &#123;</span><br><span class="line">		checkHttpNotNull(proxy);</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == httpConfig) &#123;</span><br><span class="line">			httpConfig = HttpConfig.builder().timeout(Constants.DEFAULT_TIMEOUT).build();</span><br><span class="line">		&#125;</span><br><span class="line">		proxy.setHttpConfig(httpConfig);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkHttpNotNull</span><span class="params">(Http proxy)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == proxy) &#123;</span><br><span class="line">			selectHttpProxy();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到 <code>selectHttpProxy()</code>这里是关键，通过 <code>ClassUtil.isPresent</code>的方式（即<code>Class.forName</code>）来确定 class 是否可以被加载，从上到下，如果可以被加载，就作为 http 的具体代理。（所以引入了相关的 http 依赖，<code>HttpUtils</code> 就可以直接拿来使用了）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpUtil</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> AbstractHttp proxy;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">selectHttpProxy</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">AbstractHttp</span> <span class="variable">defaultProxy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> HttpUtil.class.getClassLoader();</span><br><span class="line">		<span class="comment">// 基于 java 11 HttpClient</span></span><br><span class="line">		<span class="keyword">if</span> (ClassUtil.isPresent(<span class="string">&quot;java.net.http.HttpClient&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.java11.HttpClientImpl.class);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 基于 okhttp3</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == defaultProxy &amp;&amp; ClassUtil.isPresent(<span class="string">&quot;okhttp3.OkHttpClient&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.okhttp3.OkHttp3Impl.class);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 基于 httpclient</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == defaultProxy &amp;&amp; ClassUtil.isPresent(<span class="string">&quot;org.apache.http.impl.client.HttpClients&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.httpclient.HttpClientImpl.class);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 基于 hutool</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == defaultProxy &amp;&amp; ClassUtil.isPresent(<span class="string">&quot;cn.hutool.http.HttpRequest&quot;</span>, classLoader)) &#123;</span><br><span class="line">			defaultProxy = getHttpProxy(com.xkcoding.http.support.hutool.HutoolImpl.class);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (defaultProxy == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SimpleHttpException</span>(<span class="string">&quot;Has no HttpImpl defined in environment!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		proxy = defaultProxy;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下图，是 <code>simpleHttp</code> 默认支持的 Http 工具。</p>
<p><img src="http://cdn.lyloou.com/img/20210625112103.png" alt="image-20210625112056585"></p>
<p>也可以自己继承 <code>AbstractHttp</code>，然后调用 <code>HttpUtil#setHttp(AbstractHttp http)</code> 方法来接入自己实现的 http 工具。</p>
<p>所有实现 AbstractHttp 和 Http 的类，需要自己实现 一系列的<code>get</code>、 <code>post</code> 方法（即封装）。运行时通过面向对象中的多态来决定具体的实现者。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/business/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" rel="prev" title="分布式事务">
                  <i class="fa fa-chevron-left"></i> 分布式事务
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/business/%E7%AD%BE%E5%90%8D%E8%AE%BE%E8%AE%A1/" rel="next" title="接口签名校验设计">
                  接口签名校验设计 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  
  <div class="comments giscus-container">
  </div>
  
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备18151128号 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lyloou</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>






  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"lyloou/lyloou.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkxMDk1NzkyNzA=","category":"Announcements","category_id":"DIC_kwDOBogMBs4CWdfR","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
