---
title: 服务端统一返回格式
date: 2020-03-26 17:35:27
toc: true
comments: true
tags:
  - java
---

## 返回的 json 信息

- 错误情况

```json
{
  "err_code": 1003,
  "err_msg": "参数错误，超出最大数量限制"
}
```

- 正常情况

```json
{
  "err_code": 0,
  "err_msg": "ok",
  "data": {
    "id": 1,
    "name": "lyloou",
    "email": "lyloou@qq.com",
    "personal_signature": "多么美好的太阳",
    "gmt_create": "2020-01-16T09:38:18.000+0000",
    "gmt_modified": "2020-03-14T11:27:58.000+0000",
    "is_disabled": false
  }
}
```

## 具体实现

```java
public class Result {

    @JsonProperty("err_code")
    private final int status;

    @JsonProperty("err_msg")
    private String msg;

    @JsonProperty("data")
    private Object data;

    public Result(int status, String msg) {
        this.status = status;
        this.msg = msg;
    }

    public Result data(Object data) {
        this.data = data;
        return this;
    }

    public Result msg(String msg) {
        this.msg = msg;
        return this;
    }

    public Result appendMsg(String msg) {
        return appendMsg(msg, ", ");
    }

    public Result appendMsg(String msg, String sep) {
        if (!Strings.isNullOrEmpty(msg)) {
            this.msg = Joiner.on(sep).join(this.msg, msg);
        } else {
            this.msg = msg;
        }
        return this;
    }

}

```

```java
/**
 * 处理 Result 的接口，具体实现看 ResultHandlerImpl
 */
public interface ResultHandler {

    /**
     * 只需要返回 code 和 msg
     *
     * @param code 状态码
     * @return 结果
     */
    Result msgResult(StatusCode code);

    /**
     * 正常返回时，才使用这个；
     * 错误的时候，尽量不要用这个，除非前端有作处理。填写不当的 data，有可能会导致解析不对；
     *
     * @param code 错误码
     * @param data 返回给调用者的数据
     * @return 结果
     */
    Result dataResult(StatusCode code, Object data);

}
```

```java
@Component
public class ResultHandlerImpl implements ResultHandler {

    @Override
    public Result msgResult(StatusCode code) {
        StatusCodeDict status = code.get();
        return new Result(status.code(), status.msg());
    }


    @Override
    public Result dataResult(StatusCode code, Object data) {
        StatusCodeDict status = code.get();
        Result result = new Result(status.code(), status.msg());
        result.data(data);
        return result;
    }

}
```

```java
/**
 * ResultHandle 用此类作为参数。
 * 通过此接口，可以通过 lambda 的方式来获取 StatusCodeDict 里的信息
 * (<code>resultHandler.msgResult(() -> PARAM_LOGIN_ERROR);</code>)
 */
@FunctionalInterface
public interface StatusCode extends Supplier<StatusCodeDict> {
    @Override
    StatusCodeDict get();
}
```

```java
/**
 * 错误码字典
 */
public enum StatusCodeDict {


    // 通用码
    COMMON_OK(0, "ok"),
    COMMON_UNKNOWN(9999, "未知的异常"),
    COMMON_INVALID_REQUEST(9998, "无效的请求"),

    // 系统
    SYSTEM_404(404, "404你懂的"),
    SYSTEM_502(502, "服务器打洋了"),
    SYSTEM_500(500, "哎哟，这里有个锅"),

    PARAM(1001, "参数错误"),
    PARAM_BEYOND_QUANTITY_NUMBER(1003, "参数错误，超出最大数量限制"),

    // 登录
    PARAM_LOGIN_ERROR(1102, "用户名不存在或密码错误"),

    // 商品
    GOODS_IS_NOT_EXISTED(1301, "商品不存在"),
    GOODS_IS_NOT_MARKETABLE(1302, "商品已经下架"),

    DB(1401, "数据库异常"),

    UNDEFINED(1999, "未定义的业务异常"),
    ;


    private int code;
    private String msg;
    private static final Map<Integer, StatusCodeDict> dict = new HashMap<>();

    static {
        Arrays.stream(StatusCodeDict.values())
                .forEach(p -> dict.put(p.code, p));
    }

    public static StatusCodeDict of(int code) {
        return Optional.of(dict.get(code)).orElse(COMMON_UNKNOWN);
    }

    StatusCodeDict(int code, String msg) {
        this.code = code;
        this.msg = msg;
    }

    public int code() {
        return code;
    }

    public String msg() {
        return msg;
    }
}

```

## 调用

```java
@RestController
@RequestMapping(path = "${apiVersion}/user")
public class UserController {

    @Autowired
    private ResultHandler resultHandler;

    @Autowired
    UserMapper userMapper;

    @PostMapping("login")
    public Result login(
            @RequestParam("name") String name,
            @RequestParam("password") String password
    ) {
        UserPassword userPassword = userMapper.getUserPasswordByNamePassword(name, password);
        if (userPassword == null) {
            return resultHandler.msgResult(() -> PARAM_LOGIN_ERROR);
        }
        User user = userMapper.getUser(userPassword.getUserId());
        return resultHandler.dataResult(() -> COMMON_OK, user);
    }
}
```
