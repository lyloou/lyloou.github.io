---
title: Android网络相关
date: 2018-08-23 13:50:00
tags:
- android
---

## okhttp3 set cookie
### 从 webview 中获取 cookie
```java
// https://stackoverflow.com/questions/17654631/android-webview-read-cookies/20241864
public String getCookie(String siteName, String cookieName) {
    String cookieValue = null;

    CookieManager cookieManager = CookieManager.getInstance();
    String cookies = cookieManager.getCookie(siteName);
    if (cookies != null) {
        String[] temp = cookies.split(";");
        for (String ar1 : temp) {
            if (ar1.contains(cookieName)) {
                String[] temp1 = ar1.split("=");
                cookieValue = temp1[1];
            }
        }
    }
    return cookieValue;
}

// 使用
File file = new File(filePath);
RequestBody requestBody = new MultipartBody.Builder()
        .setType(MultipartBody.FORM)
        .addFormDataPart("file", file.getName(), RequestBody.create(MediaType.parse("image/*"), file))
        .build();

Request request = new Request.Builder()
        .url(callBack.getUrl())
        .post(requestBody)
        .addHeader("Accept", "*/*")
        .addHeader("cookie", "ci_session=" + getCookie(APP_URL, "ci_session"))
        .build();
client.newCall(request).enqueue(callBack);
```

### Automatic cookie handling with OkHttp 3
```java
// https://stackoverflow.com/questions/34881775/automatic-cookie-handling-with-okhttp-3/35346473
// https://github.com/franmontiel/PersistentCookieJar
CookieJar cookieJar = new PersistentCookieJar(new SetCookieCache(),
                     new SharedPrefsCookiePersistor(context));
OkHttpClient okHttpClient = new OkHttpClient.Builder()
                    .cookieJar(cookieJar)
                    .build();
```