---
title: 多端登录同步策略
date: 2020-03-27 11:58:44
toc: true
comments: true
tags:
  - android
---

## 字段表示

```
本地列表：local_list；
单项：local
本地上次修改时间：time
服务器上次修改时间：rtime

远程列表：remote_list；
单项：remote
上次修改时间：time

待同步列表： sync_list；
修改时间：time
```

## 状态判断

1. 无变化的

> (local.time == local.rtime) && (local.rtime == remote.time)

2. 本地新增的

> (local.rtime == null)

3. 远程新增的

> (remote_list.subtract(local_list))

4. 本地修改的

> (local.rtime == remote.time) && (local.time > local.rtime)

5. 远程修改的

> (local.time > local.rtime) && (remote.time > local.rtime)

6. 远程和本地都有修改的

> (local.time > local.rtime) && (remote.time > local.rtime)

## 冲突解决

对于前 5 个状态，是不需要处理冲突的， 简单的合并处理即可。

对于第 6 个，是需要手动来解决的。

## 上传同步

1. 取当前时间：

```kotlin
val now = Date().time
```

2. 设置修改时间：

```kotlin
sync_list.map { it.time=now }
local_list.map { it.rtime=now; it.time=now }
```

3. 上传 sync_list 到服务器

## 参考：

- [Android 离线数据同步策略 | YinKH 博客](https://www.yinkh.top/article/72/)

- [基于 diff 的文件同步算法（上） - 简书](https://www.jianshu.com/p/1d889fb14ca3)

> 从客户端的角度来看，文件同步的本质是本地文件集合与云端文件集合的对比。从实现角度来讲，客户端会保存一份云端文件集合的快照，通过将快照和云端集合对比可以计算出云端文件变更，通过将快照和本地集合对比则可以计算出本地文件变更。对于本地文件的变更，需要将文件提交至云端；对于云端文件的变更，需要将文件同步至本地。对于文件同步在云端和本地都有修改的情况下，就需要进行冲突处理。

为减少内存占用，不采取云端快照到本地的方式；这里换了种方式：在本地数据库中加了个 rtime ，来区别同步状态；

## 扩展

- 在处理冲突期间，远程数据库已经被另一端上传覆盖了。
