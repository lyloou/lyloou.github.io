---
title: 设计模式-单例
date: 2017-08-25 18:28:15
toc: true
comments: true
tags:
- 设计模式
---

```java
public class P66{
    private static void main(String []args) {
        for (int i = 0; i < 10000; i++) {
            new Thread(() -> {
                Singleton.getInstance().doSth(); // ok, only create one instance
//                Singleton.getInstance2().doSth(); // error, will create more than one instance
//                Singleton.getInstance3().doSth(); // error, will create more than one instance, too
//                Singleton.getInstance4().doSth(); // error, maybe cause NullPointerException
            }).start();
        }
    }

    private static class Singleton {
        private static Singleton instance;
        private static int count;

        private Singleton() {
            count = count + 1;
            if (count > 0) {
                System.out.println(count);
            }
        }

        private void doSth() {
            // do something
        }

        // double check
        public static Singleton getInstance() {
            if (instance == null) {
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (Singleton.class) {
                    if (instance == null) {
                        instance = new Singleton();
                    }
                }
            }
            return instance;
        }

        public static Singleton getInstance2() {
            if (instance == null) {
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                instance = new Singleton();
            }
            return instance;
        }

        public static Singleton getInstance3() {
            if (instance == null) {
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (Singleton.class) {
                    instance = new Singleton();
                }
            }
            return instance;
        }

        public static Singleton getInstance4() {
            if (instance == null) {
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }

                if (count > 0) {
                    return instance;
                } else {
                    instance = new Singleton();
                }
            }
            return instance;
        }
    }
}
```